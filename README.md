**1.1 编写目的**
本文档的编写目的是为“基于微服务架构的校园二手交易平台”项目的开发提供清晰、全面的需求规格说明。它旨在：
a. 作为项目发起人（学生用户、学校管理者）、用户（学生）和软件开发人员之间对系统需求的共同理解基础。
b. 详细定义系统的功能、数据、性能、接口和可靠性等方面的要求，作为后续系统设计、编码和测试的基础。
c. 作为项目验收的标准和用户进行确认测试的依据。

**1.2 参考资料**
a. 项目来源：计算机信息系统系《信息系统分析与设计》课程设计要求。
b. 本文档中引用到的规范和资料等：
    * 《信息系统分析与设计》课程教材及相关讲义。
    * 吕智慧老师《信息系统分析与设计》课程教学大纲。
    * 现有主流二手交易平台（如闲鱼、转转）功能调研报告。
    * 微服务架构设计相关文献与模式。
    * 复旦大学校园信息化建设相关规范（如统一身份认证接口文档，若可获取）。
c. 列出这些规范和资料的作者、编号、标题、发表日期、出版单位或资料来源。（此处请同学们自行补充详细信息）

**1.3 术语和缩写词***
*   **平台**：指本文档所描述的“基于微服务架构的校园二手交易平台”。
*   **微服务 (Microservices)**：一种架构风格，将单一应用程序开发为一组小型、独立部署的服务。
*   **SSO (Single Sign-On)**：单点登录，此处特指对接学校统一身份认证系统。
*   **LBS (Location-Based Services)**：基于位置的服务，用于校内精准定位与配送。
*   **API (Application Programming Interface)**：应用程序编程接口。
*   **卖家**：在平台上发布并出售二手物品的学生用户。
*   **买家**：在平台上浏览并购买二手物品的学生用户。
*   **商品**：指用户在平台上发布的二手物品。
*   **订单**：买卖双方就某一商品达成交易意向后生成的记录。
*   **信用评价**：用户基于交易行为对其他用户进行的评价体系。
*   **JWT (JSON Web Token)**: 一种开放标准 (RFC 7519)，它定义了一种紧凑且自包含的方式，用于在各方之间安全地传输信息作为JSON对象。

**2 业务流程分析**

**2.1 组织机构调查**
本系统主要服务于复旦大学在校学生群体，潜在用户也可能包括教职工。系统不涉及复杂的实体组织机构，其核心是连接校园内的个体卖家和买家。
主要参与角色：
*   **学生用户**：作为平台的主要使用者，既可以是卖家，也可以是买家。需通过学校统一身份认证。
*   **平台管理员**（未来可能）：负责系统监控、内容审核、用户纠纷处理、系统维护等。

**2.2 现行业务流程**
目前校园内的二手交易主要通过以下几种方式进行：

**2.2.1 当前校园线下二手交易流程**
*   **流程描述**：学生通过校园BBS、微信群、QQ群、宿舍楼公告栏发布二手物品信息，或通过熟人介绍、校园集市等方式进行点对点交易。
*   **相关岗位及主要职责**：
    *   卖家：发布信息、与买家沟通、约定交易地点和时间、完成物品交付和收款。
    *   买家：浏览信息、与卖家沟通、约定交易地点和时间、完成付款和物品接收。
*   **流程图**：
    ```
    +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |
    |  卖家整理物品  +---->+  发布信息到   +---->+  潜在买家     |
    |  确定价格      |     |  微信群/BBS等  |     |  浏览信息     |
    |                |     |                |     |                |
    +----------------+     +----------------+     +-------+--------+
                                                          |
                                                          v
    +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |
    |  交易完成      +<----+  当面交易     +<----+  买家联系卖家  |
    |  物品交付      |     |  验货支付     |     |  协商细节      |
    |                |     |                |     |                |
    +----------------+     +----------------+     +----------------+
    ```
*   **流程详述**：
    1.  卖家整理闲置物品，确定价格。
    2.  卖家通过微信群、QQ群、BBS论坛、宿舍公告栏等渠道发布物品信息（描述、图片、价格、联系方式）。
    3.  潜在买家浏览信息，如感兴趣则通过卖家留下的联系方式进行沟通。
    4.  双方协商价格、交易时间、交易地点（通常为校内某地，如宿舍楼下、食堂门口）。
    5.  双方按约定时间和地点见面，买家验货。
    6.  验货满意后，买家当面支付现金或通过移动支付（微信/支付宝）转账给卖家。
    7.  卖家交付物品，交易完成。

**2.2.2 当前通过通用线上平台进行校园二手交易流程**
*   **流程描述**：学生通过闲鱼、转转等通用型二手交易平台进行交易，但通常仍选择校内面交。
*   **相关岗位及主要职责**：
    *   卖家：在通用平台发布信息、与买家沟通、协商交易方式（邮寄或面交）、完成物品交付和收款。
    *   买家：在通用平台浏览信息、与卖家沟通、协商交易方式、完成付款和物品接收。
*   **流程图**：
    ```
    +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |
    |  卖家在平台    +---->+  校内买家     +---->+  双方平台内   |
    |  发布商品      |     |  搜索/浏览    |     |  沟通细节     |
    |                |     |                |     |                |
    +----------------+     +----------------+     +-------+--------+
                                                          |
                                                          v
    +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |
    |  交易完成      +<----+  校内面交     +<----+  约定校内     |
    |  评价对方      |     |  或平台支付   |     |  交易地点     |
    |                |     |                |     |                |
    +----------------+     +----------------+     +----------------+
    ```
*   **流程详述**：
    1.  卖家在通用二手平台（如闲鱼）注册账户，发布商品信息。
    2.  校内买家在平台上搜索商品，或通过筛选同校用户找到商品。
    3.  买家通过平台聊天工具与卖家沟通，确认商品细节和交易方式。
    4.  若选择面交，双方约定校内交易时间和地点。
    5.  交易方式可能为：
        a.  买家在平台下单，卖家选择“无需邮寄”，双方见面后买家确认收货，平台将款项转给卖家。
        b.  双方跳过平台支付流程，直接线下支付。
    6.  双方见面，买家验货，完成支付和物品交接。

**2.2.3 新系统校园二手交易流程图（基于微服务架构）**
```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  卖家SSO登录   +---->+  发布商品到   +---->+  买家浏览/    |
|  校园平台      |     |  校园平台     |     |  搜索商品     |
|                |     |                |     |                |
+----------------+     +----------------+     +-------+--------+
                                                      |
                                                      v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  卖家确认订单  +<----+  系统生成     +<----+  买家提交     |
|                |     |  交易订单     |     |  购买请求     |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
       |
       v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  校内面交/     +---->+  买家确认     +---->+  双方互评     |
|  自提点交付    |     |  收货         |     |  交易完成     |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
```

**2.2.4 商品发布流程活动图**
```
+----------------+
|                |
|  开始          |
|                |
+-------+--------+
        |
        v
+----------------+     +----------------+
|                |     |                |
|  用户登录      +---->+  选择发布     |
|  (SSO认证)     |     |  商品功能     |
|                |     |                |
+----------------+     +-------+--------+
                               |
                               v
+----------------+     +----------------+
|                |     |                |
|  填写商品信息  +---->+  上传商品     |
|  (名称/描述等) |     |  图片         |
|                |     |                |
+----------------+     +-------+--------+
                               |
                               v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  系统校验      +---->+  信息合规?    +---->+  否: 返回修改 |
|  商品信息      |     |                |     |                |
|                |     |                |     +----------------+
+----------------+     +-------+--------+
                               |
                               | 是
                               v
+----------------+     +----------------+
|                |     |                |
|  保存商品信息  +---->+  商品发布成功 |
|  设置状态为    |     |  (在售)       |
|  "在售"        |     |                |
+----------------+     +----------------+
```

**2.2.5 交易流程活动图**
```
+----------------+
|                |
|  开始          |
|                |
+-------+--------+
        |
        v
+----------------+     +----------------+
|                |     |                |
|  买家浏览/     +---->+  选择商品并   |
|  搜索商品      |     |  点击购买     |
|                |     |                |
+----------------+     +-------+--------+
                               |
                               v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  系统检查      +---->+  商品可购买?  +---->+  否: 提示     |
|  商品状态      |     |                |     |  不可购买     |
|                |     |                |     |                |
+----------------+     +-------+--------+     +----------------+
                               |
                               | 是
                               v
+----------------+     +----------------+
|                |     |                |
|  生成订单      +---->+  通知卖家     |
|                |     |  有新订单      |
|                |     |                |
+----------------+     +-------+--------+
                               |
                               v
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  卖家处理      +---->+  接受订单?    +---->+  否: 订单取消 |
|  订单          |     |                |     |                |
|                |     |                |     |                |
+----------------+     +-------+--------+     +----------------+
                               |
                               | 是
                               v
+----------------+     +----------------+
|                |     |                |
|  买卖双方      +---->+  买家确认     |
|  协商交易      |     |  收货         |
|  细节          |     |                |
+----------------+     +-------+--------+
                               |
                               v
+----------------+     +----------------+
|                |     |                |
|  交易完成      +---->+  双方互评     |
|                |     |                |
|                |     |                |
+----------------+     +----------------+
```

**2.3 问题分析***
对现行业务流程进行分析，存在以下问题和痛点：
*   **信息不对称与效率低下（针对线下流程）**：
    *   信息发布渠道分散（BBS、微信群、公告栏），覆盖面有限，查找困难。
    *   缺乏统一的商品展示和搜索功能，买家找物品、卖家找买家效率低。
    *   交易时间、地点协调成本高。
*   **信任问题**：
    *   线下交易缺乏身份验证，难以确认对方是否为本校学生，存在一定安全隐患。
    *   缺乏信用评价体系，难以判断交易对象的可靠性。
    *   通用线上平台虽有评价，但对校园场景针对性不强。
*   **校园场景针对性不足（针对通用线上平台）**：
    *   通用平台功能庞杂，不完全契合校园用户简洁、高效的需求。
    *   缺乏与学校系统的整合，如统一身份认证，无法有效保障用户身份的真实性（校内用户）。
    *   校内LBS功能不突出，难以实现精准的校内物品推荐或快速面交引导。
*   **交易保障有限**：
    *   线下交易一旦发生纠纷，难以追溯和解决。
    *   通用线上平台虽有保障机制，但流程可能繁琐，且对校内小额高频交易可能不适用。
*   **管理缺失**：
    *   缺乏对违禁品、虚假信息的有效管理和过滤机制。

**3 需求**

**3.1 功能需求**
本平台旨在提供一个安全、便捷、高效的校园二手交易环境。主要用户为在校学生（买家/卖家），未来可扩展至教职工。
系统核心功能模块（基于微服务划分设想）：

*   **用户认证与管理服务**：
    *   用户注册：支持通过学校统一身份认证系统（SSO）快速注册/登录。
    *   用户登录/登出。
    *   个人信息管理：昵称、头像、联系方式（可选择性公开）、校区/楼栋信息（用于LBS）。
    *   查看交易历史、我的发布、我的收藏等。
*   **商品管理服务**：
    *   发布商品：填写商品名称、描述、上传图片/视频、选择分类、设定价格、选择交易方式（校内面交/自提点/小型物品楼栋间代送等）、填写校内大致位置。
    *   编辑/删除已发布商品。
    *   商品搜索与浏览：支持关键词搜索、分类筛选、价格区间筛选、校区/距离筛选。
    *   商品详情展示：展示商品所有信息、卖家信息（部分）、信用评价。
    *   商品收藏/取消收藏。
    *   商品推荐*：基于用户浏览历史、收藏、地理位置等进行个性化推荐。
*   **订单与交易服务**：
    *   创建订单：买家选择商品后，与卖家确认交易意向，生成订单。
    *   订单管理（买家）：查看订单状态（待付款、待收货、已完成、已取消）、取消订单（特定条件下）。
    *   订单管理（卖家）：查看订单状态、接受/拒绝订单、确认发货/已面交。
    *   支付功能*：（初期可引导线下支付，备注已支付；远期可集成校园卡支付或第三方支付接口）。
    *   确认收货。
*   **信用评价服务**：
    *   交易双方互评：交易完成后，买卖双方可对本次交易及对方进行评价和打分。
    *   信用积分计算：根据用户交易行为（成功交易次数、好评率、违规记录等）计算信用分。
    *   展示用户信用等级/评分。
*   **消息通知服务**：
    *   系统通知：注册成功、订单状态变更、重要公告等。
    *   用户间私信：买卖双方就商品或交易细节进行沟通。
    *   新消息提醒。
*   **后台管理服务**（针对平台管理员）：
    *   用户管理：查看用户信息、禁用违规用户。
    *   商品审核与管理*：审核新发布商品、下架违规商品。
    *   订单管理与仲裁*：查看所有订单、处理交易纠纷。
    *   分类管理：增删改商品分类。
    *   系统公告发布。

**用例图：**

**总体用例图**
```
                                  +---------------------+
                                  |                     |
                                  |    校内二手交易     |
                                  |    平台系统         |
                                  |                     |
                                  +---------------------+
                                           ^
                                           |
              +---------------------------+----------------------------+
              |                           |                            |
    +---------+----------+     +----------+---------+      +-----------+--------+
    |                    |     |                    |      |                    |
    |   学生用户         |     |   学生用户         |      |   管理员           |
    |   (买家角色)       |     |   (卖家角色)       |      |                    |
    |                    |     |                    |      |                    |
    +---------+----------+     +----------+---------+      +-----------+--------+
              |                           |                            |
              v                           v                            v
    +------------------+        +------------------+         +------------------+
    | - 注册/登录      |        | - 注册/登录      |         | - 管理用户       |
    | - 浏览商品       |        | - 发布商品       |         | - 管理商品       |
    | - 搜索商品       |        | - 管理我的商品   |         | - 管理订单       |
    | - 收藏商品       |        | - 处理订单请求   |         | - 管理分类       |
    | - 发起购买       |        | - 确认交易       |         | - 发布公告       |
    | - 管理我的订单   |        | - 管理我的订单   |         | - 处理纠纷       |
    | - 评价交易       |        | - 评价交易       |         | - 系统监控       |
    | - 发送/接收消息  |        | - 发送/接收消息  |         |                  |
    +------------------+        +------------------+         +------------------+
```

**用户管理模块用例图**
```
                          +---------------------+
                          |                     |
                          |    用户管理服务     |
                          |                     |
                          +---------------------+
                                   ^
                                   |
              +------------------+-+------------------+
              |                  |                    |
    +---------+--------+  +------+-------+    +-------+--------+
    |                  |  |              |    |                |
    |   学生用户       |  |   管理员     |    |   SSO系统      |
    |                  |  |              |    |                |
    +---------+--------+  +------+-------+    +----------------+
              |                  |
              v                  v
    +------------------+  +------------------+
    | - 通过SSO注册    |  | - 查看用户列表   |
    | - 登录/登出      |  | - 查看用户详情   |
    | - 查看个人信息   |  | - 禁用/启用用户  |
    | - 修改个人信息   |  | - 重置用户信用分 |
    | - 修改密码       |  |                  |
    | - 查看信用评分   |  |                  |
    +------------------+  +------------------+
```

**商品管理模块用例图**
```
                          +---------------------+
                          |                     |
                          |    商品管理服务     |
                          |                     |
                          +---------------------+
                                   ^
                                   |
              +------------------+-+------------------+
              |                  |                    |
    +---------+--------+  +------+-------+    +-------+--------+
    |                  |  |              |    |                |
    |   卖家           |  |   买家       |    |   管理员       |
    |                  |  |              |    |                |
    +---------+--------+  +------+-------+    +-------+--------+
              |                  |                    |
              v                  v                    v
    +------------------+  +------------------+  +------------------+
    | - 发布商品       |  | - 浏览商品       |  | - 审核商品       |
    | - 编辑商品       |  | - 搜索商品       |  | - 下架违规商品   |
    | - 上传商品图片   |  | - 查看商品详情   |  | - 管理商品分类   |
    | - 下架商品       |  | - 收藏商品       |  | - 查看所有商品   |
    | - 查看我的商品   |  | - 查看收藏商品   |  |                  |
    +------------------+  +------------------+  +------------------+
```

**订单与交易模块用例图**
```
                          +---------------------+
                          |                     |
                          |  订单与交易服务     |
                          |                     |
                          +---------------------+
                                   ^
                                   |
              +------------------+-+------------------+
              |                  |                    |
    +---------+--------+  +------+-------+    +-------+--------+
    |                  |  |              |    |                |
    |   买家           |  |   卖家       |    |   管理员       |
    |                  |  |              |    |                |
    +---------+--------+  +------+-------+    +-------+--------+
              |                  |                    |
              v                  v                    v
    +------------------+  +------------------+  +------------------+
    | - 创建订单       |  | - 查看订单请求   |  | - 查看所有订单   |
    | - 取消订单       |  | - 接受/拒绝订单  |  | - 处理订单纠纷   |
    | - 支付订单       |  | - 确认发货/面交  |  | - 取消异常订单   |
    | - 确认收货       |  | - 取消订单       |  | - 生成交易报表   |
    | - 查看我的订单   |  | - 查看我的订单   |  |                  |
    +------------------+  +------------------+  +------------------+
```

**评价与信用模块用例图**
```
                          +---------------------+
                          |                     |
                          |  评价与信用服务     |
                          |                     |
                          +---------------------+
                                   ^
                                   |
              +------------------+-+------------------+
              |                  |                    |
    +---------+--------+  +------+-------+    +-------+--------+
    |                  |  |              |    |                |
    |   买家           |  |   卖家       |    |   管理员       |
    |                  |  |              |    |                |
    +---------+--------+  +------+-------+    +-------+--------+
              |                  |                    |
              v                  v                    v
    +------------------+  +------------------+  +------------------+
    | - 评价卖家       |  | - 评价买家       |  | - 查看所有评价   |
    | - 查看我的评价   |  | - 查看我的评价   |  | - 处理评价纠纷   |
    | - 查看卖家评价   |  | - 查看买家评价   |  | - 删除违规评价   |
    | - 查看我的信用分 |  | - 查看我的信用分 |  | - 调整用户信用分 |
    +------------------+  +------------------+  +------------------+
```

**消息通知模块用例图**
```
                          +---------------------+
                          |                     |
                          |  消息通知服务       |
                          |                     |
                          +---------------------+
                                   ^
                                   |
              +------------------+-+------------------+
              |                  |                    |
    +---------+--------+  +------+-------+    +-------+--------+
    |                  |  |              |    |                |
    |   学生用户       |  |   系统       |    |   管理员       |
    |                  |  |              |    |                |
    +---------+--------+  +------+-------+    +-------+--------+
              |                  |                    |
              v                  v                    v
    +------------------+  +------------------+  +------------------+
    | - 发送私信       |  | - 发送系统通知   |  | - 发布系统公告   |
    | - 接收私信       |  | - 订单状态通知   |  | - 发送批量通知   |
    | - 查看消息列表   |  | - 评价提醒       |  | - 查看消息记录   |
    | - 标记已读/未读  |  | - 商品状态通知   |  | - 管理通知模板   |
    | - 删除消息       |  |                  |  |                  |
    +------------------+  +------------------+  +------------------+
```

**用例详细规格说明（示例1）：**

**表1 用例的详细规格说明 (发布二手商品)**
| 用例名称     | 发布二手商品                                                 |
| :----------- | :----------------------------------------------------------- |
| 参与者       | 卖家（主要参与者）                                           |
| 假设         | 1. 用户已登录系统并通过身份认证。 2. 平台商品分类已预设。    |
| 前置条件     | 卖家已登录系统。                                             |
| 后置条件     | 1. 商品信息成功存储到数据库。 2. 商品在平台上对其他用户可见。 |
| 主事件流     | 1. 卖家选择“发布商品”功能。                                  |
|              | 2. 系统展示商品信息填写表单（名称、描述、分类、价格、图片、交易方式、位置等）。 |
|              | 3. 卖家填写商品信息并上传图片。                              |
|              | 4. 卖家确认信息无误，点击“发布”。                            |
|              | 5. 系统校验商品信息的完整性和合规性。                        |
|              | 6. 系统保存商品信息，并将其状态设置为“在售”。                |
|              | 7. 系统提示“商品发布成功”。                                  |
| 备选事件流   | 5a. 商品信息不完整或包含非法字符/图片：                      |
|              | 1. 系统提示错误信息，要求卖家修改。用例返回步骤3。           |
|              | 5b. 系统检测到疑似违禁品（通过关键词过滤等）：               |
|              | 1. 系统提示商品需要人工审核，暂时不予发布。用例结束或转人工审核流程。 |
| 非功能性需求 | 图片上传速度应在可接受范围内（如 <5秒/MB），界面响应及时。   |

**用例详细规格说明（示例2）：**

**表2 用例的详细规格说明 (购买商品)**
| 用例名称     | 购买商品                                                     |
| :----------- | :----------------------------------------------------------- |
| 参与者       | 买家（主要参与者），卖家（次要参与者）                       |
| 假设         | 1. 买家已登录并通过身份认证。 2. 卖家发布的商品信息准确。    |
| 前置条件     | 1. 买家已登录系统。 2. 买家已选定意向购买的商品。            |
| 后置条件     | 1. 生成订单记录。 2. 更新商品状态（如被预订或等待卖家确认）。 3. 通知卖家有新订单。 |
| 主事件流     | 1. 买家在商品详情页点击“立即购买”或“联系卖家”后确认购买意向。 |
|              | 2. 系统展示订单确认页面，包含商品信息、价格、卖家信息（部分）、建议交易方式。 |
|              | 3. 买家确认订单信息，点击“提交订单”。                        |
|              | 4. 系统生成订单，状态为“待卖家确认”或“待付款”（取决于支付设计）。 |
|              | 5. 系统通知卖家有新的购买请求。                              |
|              | 6. 系统提示买家“订单已提交，等待卖家处理”。                  |
| 备选事件流   | 4a. 商品已被其他用户预订或下架：                             |
|              | 1. 系统提示“商品状态已更新，无法购买”，用例结束。            |
|              | 4b. 买家账户存在异常（如信用分过低被限制交易）：             |
|              | 1. 系统提示“账户异常，暂时无法交易”，用例结束。              |
| 非功能性需求 | 订单生成过程应在数秒内完成，系统需保证交易数据的准确性和一致性。 |

*(请根据实际情况，为其他核心用例（如用户注册登录、搜索商品、评价交易等）参照《详细用例说明.md》文件撰写详细规格说明，此处不重复列出)*

**3.2 数据需求**
系统核心实体及其主要属性：
*   **用户 (User)**：用户ID (主键), 学号/工号 (唯一, 用于SSO关联), 昵称, 头像URL, 手机号 (可选, 加密), 邮箱 (可选, 加密), 校区, 楼栋信息, 注册时间, 最后登录时间, 信用分, 用户状态 (正常/禁用)。
*   **商品 (Product/Item)**：商品ID (主键), 卖家用户ID (外键关联User), 商品名称, 商品描述, 价格, 分类ID (外键关联Category), 发布时间, 商品状态 (在售/已预订/已售出/下架), 图片/视频URL列表, 交易方式偏好, 校内大致位置 (LBS相关)。
*   **分类 (Category)**：分类ID (主键), 分类名称, 父分类ID (用于多级分类)。
*   **订单 (Order)**：订单ID (主键), 买家用户ID (外键关联User), 卖家用户ID (外键关联User), 商品ID (外键关联Product), 下单时间, 订单金额, 订单状态 (待确认/待付款/待收货/已完成/已取消/纠纷中), 交易时间, 交易地点备注, 商品快照。
*   **评价 (Review/Rating)**：评价ID (主键), 订单ID (外键关联Order), 评价方用户ID (外键关联User), 被评价方用户ID (外键关联User), 评分 (1-5星), 评价内容, 评价时间。
*   **消息 (Message)**：消息ID (主键), 发送方用户ID (外键关联User), 接收方用户ID (外键关联User), 消息内容, 发送时间, 消息类型 (私信/系统通知), 已读状态。
*   **收藏 (Favorite)**：收藏ID (主键), 用户ID (外键关联User), 商品ID (外键关联Product), 收藏时间。
*   **信用历史 (CreditHistory)**: 历史ID (主键), 用户ID (外键关联User), 变更分值, 变更原因, 来源类型 (交易/评价/管理员调整), 来源ID, 创建时间。

**总体领域类图：**
```
+----------------+      +----------------+      +----------------+
|     User       |      |    Product     |      |    Category    |
+----------------+      +----------------+      +----------------+
| -userId: Long  |<>--->| -productId: Long|----->| -categoryId: Long|
| -studentId: String|   | -sellerId: Long |      | -name: String  |
| -username: String|    | -title: String  |      | -parentId: Long|
| -passwordHash: String| | -description: String| | -level: Integer|
| -avatarUrl: String|   | -price: BigDecimal|   | -createdAt: DateTime|
| -phone: String  |     | -categoryId: Long|    +----------------+
| -email: String  |     | -status: Enum   |
| -schoolCampus: String| | -imageUrls: List<String>|
| -buildingInfo: String| | -preferredTransactionMode: String|
| -creditScore: Integer| | -locationHint: String|
| -status: Enum   |     | -postedAt: DateTime|
| -createdAt: DateTime| | -updatedAt: DateTime|
| -updatedAt: DateTime| +----------------+
+----------------+              |
       |                        |
       |                        |
       v                        v
+----------------+      +----------------+      +----------------+
|     Order      |      |    Favorite    |      |    Review     |
+----------------+      +----------------+      +----------------+
| -orderId: Long |      | -favoriteId: Long|    | -reviewId: Long|
| -buyerId: Long |<-----| -userId: Long  |     | -orderId: Long |
| -sellerId: Long|      | -productId: Long|     | -reviewerId: Long|
| -productId: Long|     | -createdAt: DateTime| | -revieweeId: Long|
| -productSnapshot: JSON| +----------------+    | -rating: Integer|
| -orderAmount: BigDecimal|                     | -comment: String|
| -status: Enum   |                            | -createdAt: DateTime|
| -createdAt: DateTime|                        +----------------+
| -updatedAt: DateTime|                               |
| -transactionTime: DateTime|                         |
| -transactionLocation: String|                       |
+----------------+                                    |
       |                                              |
       |                                              |
       v                                              v
+----------------+                           +----------------+
|    Message     |                           | CreditHistory  |
+----------------+                           +----------------+
| -messageId: Long|                          | -historyId: Long|
| -senderId: Long|                           | -userId: Long  |
| -receiverId: Long|                         | -changeAmount: Integer|
| -content: String|                          | -reason: String|
| -sentTime: DateTime|                       | -sourceType: Enum|
| -type: Enum    |                           | -sourceId: Long|
| -readStatus: Boolean|                      | -createdAt: DateTime|
+----------------+                           +----------------+
```

**3.3 性能需求***
*   **响应时间**：
    *   核心页面（首页、商品列表页、商品详情页）加载时间应小于 2 秒。
    *   用户执行常规操作（如发布商品、下单、搜索）的系统响应时间应小于 1 秒。
    *   图片等静态资源加载应进行优化，不阻塞页面主要内容呈现。
*   **并发用户数**：
    *   系统初期应能支持至少 500-1000 名并发用户访问。
    *   微服务架构应支持按需扩展，以应对高峰期（如开学季、毕业季）的更高并发。
*   **数据处理能力**：
    *   订单生成、支付状态更新等核心交易流程需保证高可靠性和数据一致性。
    *   商品搜索功能在百万级商品数据量下，平均查询时间应小于1秒。

**3.4 非功能需求***
*   **安全性**：
    *   用户身份认证：对接学校统一身份认证系统，确保用户身份真实性。
    *   数据安全：对用户敏感信息（如联系方式、交易记录）进行加密存储和传输。
    *   防范常见Web攻击（如XSS, CSRF, SQL注入）。
    *   微服务间通信安全。
*   **可靠性/可用性**：
    *   核心服务（用户、商品、订单）应保证 99.9% 的可用性。
    *   微服务架构应具备容错能力，单个服务故障不应导致整个系统瘫痪。
    *   数据备份与恢复机制。
*   **可扩展性**：
    *   采用微服务架构，各服务可独立开发、部署和扩展。
    *   方便未来新增功能模块（如闲置教材、活动票务专区）。
*   **可维护性**：
    *   各微服务职责单一，代码模块化，易于理解和维护。
    *   提供清晰的API文档。
    *   完善的日志记录和监控机制。
*   **易用性**：
    *   界面设计简洁、直观，符合校园用户使用习惯。
    *   操作流程清晰、便捷。
    *   提供必要的帮助和引导信息。
*   **兼容性**：
    *   Web端应兼容主流浏览器（Chrome, Firefox, Safari, Edge最新版本）。
    *   若开发移动端，需考虑iOS和Android平台的兼容性。

**4 环境**

**4.1 运行环境**
*   **服务器端**：
    *   操作系统：Linux (如 CentOS, Ubuntu)。
    *   Web服务器：Nginx (作为反向代理和负载均衡)。
    *   应用服务器/运行时：
        *   各微服务可采用不同技术栈，如 Java (Spring Boot/Spring Cloud), Python (Flask/Django), Node.js (Express)。
        *   容器化技术：Docker。
        *   容器编排：Kubernetes (可选，视规模而定)。
    *   数据库服务器：
        *   关系型数据库：MySQL / PostgreSQL (用于订单、用户信息等事务性数据)。
        *   NoSQL数据库：MongoDB (用于商品信息、评论等), Redis (用于缓存、会话管理)。
    *   消息队列：RabbitMQ / Kafka (用于服务间异步通信、解耦)。
    *   API网关：Spring Cloud Gateway / Kong。
    *   服务注册与发现：Consul / Eureka / Nacos。
    *   （可选）分布式搜索引擎：Elasticsearch (用于商品搜索)。
*   **客户端**：
    *   Web浏览器：支持HTML5、CSS3、JavaScript的主流现代浏览器。
    *   （未来）移动客户端：iOS, Android 操作系统, 微信小程序。
*   **网络环境**：校园网及互联网访问。

**4.2 开发环境**
*   **硬件环境**：开发人员自备笔记本电脑。
*   **软件环境**：
    *   操作系统：Windows, macOS, Linux。
    *   IDE：IntelliJ IDEA (Java), VS Code (Python/Node.js/Frontend), Eclipse等。
    *   编程语言：Java, Python, Node.js, JavaScript, HTML, CSS等。
    *   框架与库：Spring Boot/Cloud, Flask/Django, Express, Vue.js/React/Angular (前端)等。
    *   版本控制：Git, GitLab/GitHub。
    *   数据库管理工具：Navicat, DBeaver, pgAdmin。
    *   建模工具：Visio, PowerDesigner, draw.io, StarUML。
    *   API测试工具：Postman, Insomnia。
    *   项目管理与协作：Jira, Trello, Teambition (可选)。
    *   构建工具：Maven/Gradle (Java), npm/yarn (Node.js/Frontend)。
    *   虚拟化/容器：Docker Desktop。

**5 总体结构设计**

**5.1 对外接口设计**
本系统作为平台，主要存在以下对外接口：

1.  **学校统一身份认证系统 (SSO) 接口**：
    *   **需求接口**：本平台需要调用学校SSO系统提供的认证接口，传递用户凭证（如CAS Ticket），获取用户基本身份信息（学号、姓名等）以完成用户注册和登录。
    *   **协议**：通常为 OAuth 2.0, SAML, 或者学校自定义的基于Ticket的认证协议。
2.  **支付网关接口 (可选，远期)**：
    *   **需求接口**：若集成在线支付，需调用如校园卡支付网关、微信支付或支付宝提供的支付接口（创建支付订单、查询支付状态、退款等）。
3.  **地理位置服务接口 (可选，增强)**：
    *   **需求接口**：可能调用第三方地图服务API（如高德地图、百度地图API的子集）进行校内POI（Point of Interest）检索或辅助定位，但主要依赖用户自行填写的校区/楼栋信息。
4.  **本平台提供的API接口 (供前端或其他潜在客户端调用)**：
    *   **提供接口**：平台将为前端（Web/App/小程序）提供一套完整的RESTful API，用于实现所有用户交互功能。这些API将由API网关统一管理和暴露。
        *   用户服务API (e.g., `/api/users/register`, `/api/users/login`, `/api/users/profile`)
        *   商品服务API (e.g., `/api/products`, `/api/products/{id}`, `/api/products/search`)
        *   订单服务API (e.g., `/api/orders`, `/api/orders/{id}/confirm`)
        *   评价服务API (e.g., `/api/reviews`)
        *   消息服务API (e.g., `/api/messages`)

**微服务架构总体图**
```
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|  Web前端         |     |  移动端应用      |     |  微信小程序      |
|  (Vue.js/React)  |     |  (可选)          |     |  (WXML/WXSS)     |
|                  |     |                  |     |                  |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         v                        v                        v
+----------------------------------------------------------+
|                                                          |
|  API网关 (Gateway)                                       |
|  (路由, 认证, 限流, 日志)                                  |
|                                                          |
+--------------------------+-------------------------------+
                           |
                           |
        +------------------v------------------+
        |                                     |
        |  认证授权服务 (Auth Service)        |
        |  (JWT颁发/校验, 对接SSO/微信登录)   |
        |                                     |
        +-------------------------------------+
                           |
                           | (内部服务调用或消息队列)
+--------------------------+-------------------------------------------------------------+
|        |                 |                  |                  |                        |
v        v                 v                  v                  v                        v
+--------+-------+ +-------+--------+ +-------+--------+ +-------+--------+ +--------------+--------+ +-------------+
|                | |                | |                | |                | |                       | |             |
| 用户服务       | | 商品服务       | | 订单服务       | | 评价服务       | | 消息服务              | | 配置中心    |
| (User Service) | | (Product Ser.) | | (Order Service)| | (Review Ser.)  | | (Message/Notif Ser.)  | | (Config)    |
|                | |                | |                | |                | |                       | |             |
+--------+-------+ +-------+--------+ +-------+--------+ +-------+--------+ +--------------+--------+ +-------------+
         |                 |                  |                  |                        |
         v                 v                  v                  v                        v
+--------+-------+ +-------+--------+ +-------+--------+ +-------+--------+ +--------------+--------+
|                | |                | |                | |                | |                       |
| 用户数据库     | | 商品数据库     | | 订单数据库     | | 评价数据库     | | 消息数据库            |
| (MySQL/PGSQL)  | | (MongoDB/MySQL)| | (MySQL/PGSQL)  | | (MySQL/PGSQL)  | | (MongoDB/RabbitMQ)    |
|                | |                | |                | |                | |                       |
+----------------+ +----------------+ +----------------+ +----------------+ +-----------------------+

                                +---------------------+
                                |                     |
                                | 服务注册与发现中心  |
                                | (Registry: Eureka, Nacos) |
                                |                     |
                                +---------------------+

                                +---------------------+
                                |                     |
                                | 消息队列            |
                                | (RabbitMQ / Kafka)  |
                                |                     |
                                +---------------------+

                                +---------------------+
                                |                     |
                                | 缓存服务            |
                                | (Redis)             |
                                |                     |
                                +---------------------+

                                +---------------------+
                                |                     |
                                | 监控与日志服务      |
                                | (Prometheus, ELK)   |
                                |                     |
                                +---------------------+
```

**5.2 内部结构设计**

1.  **架构说明（分层与微服务划分）**：
    本系统采用微服务架构。逻辑上，每个微服务内部可以遵循经典的三层/多层架构：

    *   **表现层/接口层 (Presentation/API Layer)**：负责处理外部请求（如HTTP请求），通过API网关暴露RESTful API。包含Controller类，负责请求的接收、参数校验、调用业务逻辑层，并返回响应 (通常为JSON格式)。
    *   **业务逻辑层/服务层 (Business Logic/Service Layer)**：核心业务逻辑的实现，包含Service类。负责处理复杂的业务规则、事务管理、协调领域对象和数据访问层。
    *   **数据访问层 (Data Access Layer)**：负责与数据库或其他持久化存储进行交互，包含Repository/DAO类和Entity/Domain类（代表数据模型）。
    *   **领域模型层 (Domain Model Layer)**：包含核心的业务实体 (Entity) 和值对象 (Value Object)，是业务逻辑操作的核心对象。

    基于功能需求，初步的微服务划分如上述“微服务架构总体图”所示，包括：
    *   用户服务 (User Service)
    *   商品服务 (Product Service)
    *   订单服务 (Order Service)
    *   评价服务 (Review Service)
    *   消息服务 (Message Service)
    以及支撑组件：API网关, 认证授权服务, 配置中心, 服务注册与发现中心, 消息队列, 缓存服务, 监控服务。

    **微服务内部分层架构图 (示例)**
    ```
    +--------------------------------------------------+
    |                                                  |
    |                  API层 (Controller)              |
    |       (RESTful API, DTO转换, 输入校验)           |
    |                                                  |
    +------------------------+-------------------------+
                             | (调用)
                             v
    +--------------------------------------------------+
    |                                                  |
    |                  业务逻辑层 (Service)            |
    |       (核心业务逻辑, 事务管理, 领域对象编排)     |
    |                                                  |
    +------------------------+-------------------------+
                             | (调用)
                             v
    +--------------------------------------------------+
    |                                                  |
    |                  数据访问层 (Repository)         |
    |       (CRUD操作, 数据库交互, ORM)                |
    +------------------------+-------------------------+
                             | (操作)
                             v
    +--------------------------------------------------+
    |                                                  |
    |                  领域模型 (Entity/Domain)        |
    |       (数据结构, 值对象, 部分业务规则)           |
    +--------------------------------------------------+
                             ^
                             | (依赖)
    +--------------------------------------------------+
    |                                                  |
    |                  数据库 (Database)               |
    |                                                  |
    +--------------------------------------------------+
    ```

2.  **包图 (高层)**：
    在高层视角，每个微服务（用户服务、商品服务、订单服务等）可以视为一个独立的包。它们之间的依赖关系主要通过API调用（同步）或消息队列（异步）实现。例如：
    *   `OrderService` 会依赖 `UserService` (获取买家/卖家信息) 和 `ProductService` (获取商品信息、更新库存)。
    *   `ReviewService` 会依赖 `OrderService` (获取订单信息) 和 `UserService` (更新用户信用)。
    *   所有面向外部的服务都依赖于 `APIGateway` 进行请求路由和管理。
    *   多数服务会依赖 `AuthService` 进行用户认证/授权。

3.  **部署架构图**
    ```
    +------------------+     +------------------+
    |                  |     |                  |
    |  负载均衡器      |     |  CDN             |
    |  (Nginx/ELB)     |     |  (静态资源)      |
    |                  |     |                  |
    +--------+---------+     +--------+---------+
             |                        | (Web/App/小程序前端)
             |                        v
    +--------+----------------------------------+
    |                                          |
    |  Internet / Campus Network               |
    |                                          |
    +------------------+-----------------------+
                       |
                       v
    +--------------------------------------------------+
    |                                                  |
    |                  API网关 (Gateway)                 |
    |                  (Docker 容器实例)                 |
    |                                                  |
    +------------------+-----------------------+
                       | (内部网络)
                       v
    +----------------------------------------------------------------------------------------------------+
    |                                                                                                    |
    |  容器编排平台 (Docker Swarm / Kubernetes)                                                            |
    |                                                                                                    |
    |  +-----------------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+ |
    |  | Auth Service    |  | User Service    |  | Product Service |  | Order Service   |  | ... (其他服务)  | |
    |  | (Docker 实例)   |  | (Docker 实例)   |  | (Docker 实例)   |  | (Docker 实例)   |  | (Docker 实例)   | |
    |  +-----------------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+ |
    |                                                                                                    |
    |  +-----------------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+ |
    |  | Config Center   |  | Service Registry|  | Message Queue   |  | Cache Service   |  | Monitoring      | |
    |  | (Docker 实例)   |  | (Docker 实例)   |  | (Docker 实例)   |  | (Docker 实例)   |  | (Docker 实例)   | |
    |  +-----------------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+ |
    |                                                                                                    |
    +----------------------------------------------------------------------------------------------------+
                                                         |
                                                         v
    +----------------------------------------------------------------------------------------------------+
    |                                                                                                    |
    |  数据库集群 / 存储服务                                                                                 |
    |  (MySQL Cluster, MongoDB ReplicaSet, Redis Cluster, NFS/S3 for images)                             |
    |                                                                                                    |
    +----------------------------------------------------------------------------------------------------+
                                                         |
                                                         v
    +----------------------------------------------------------------------------------------------------+
    |                                                                                                    |
    |  物理服务器 / 云虚拟机 (IaaS)                                                                        |
    |                                                                                                    |
    +----------------------------------------------------------------------------------------------------+
    ```

**5.3 出错处理设计***

*   **统一错误响应格式**：API接口对于错误请求（客户端错误4xx，服务端错误5xx）返回统一的JSON格式，包含错误码 (error_code)，错误信息 (message)，以及可选的详细调试信息 (details) 和请求ID (trace_id)。
    ```json
    {
      "timestamp": "2023-10-27T10:30:00Z",
      "status": 404, // HTTP Status
      "error": "Not Found", // HTTP Status Text
      "errorCode": "PRODUCT_NOT_FOUND", // 业务错误码
      "message": "无法找到ID为123的商品。", // 用户友好的错误信息
      "path": "/api/products/123", // 请求路径
      "traceId": "abcdef123456" // 用于链路追踪
    }
    ```
*   **异常处理机制**：
    *   Controller层：使用全局异常处理器 (e.g., Spring MVC的 `@ControllerAdvice` 和 `@ExceptionHandler`) 捕获未处理的异常，转换为标准的错误响应。
    *   Service层：业务异常自定义并抛出 (e.g., `ProductNotFoundException`, `InsufficientStockException`, `PermissionDeniedException`)。通过异常传递错误信息，避免使用错误码作为方法返回值。
    *   Repository层：将持久化相关的异常（如数据库连接异常、数据访问违规）转换为自定义的数据访问异常或直接由框架处理。
*   **日志记录**：关键操作和错误信息将被详细记录，包括时间戳、请求ID、用户ID（如果适用）、错误堆栈等，便于问题排查。使用SLF4j + Logback/Log4j2等日志框架，并集成到ELK等集中式日志系统。
*   **微服务容错**：
    *   **熔断 (Circuit Breaker)**: 使用如 Resilience4J 或 Sentinel，当某个依赖服务故障率过高时，暂时断开对其的调用，快速失败，避免雪崩效应。
    *   **降级 (Fallback)**: 当服务调用失败或超时，提供一个预设的、简化的响应或默认值，保证核心功能可用性。
    *   **重试 (Retry)**: 对临时的网络抖动或服务短暂不可用，进行有限次数的、带退避策略的重试。
    *   **超时控制 (Timeout)**: 设置合理的API调用和服务间调用超时时间。
    *   **舱壁隔离 (Bulkhead)**: 限制对某个依赖服务的并发调用数，防止单个依赖拖垮整个服务。
    *   **幂等性设计**：对于可能重试的写操作（如创建订单、支付），需要设计成幂等的，确保多次执行产生相同结果。

**5.4 其它***

*   **安全性设计**：
    *   **认证**：API网关统一进行JWT令牌验证。用户登录后，认证授权服务颁发JWT。对于SSO，用户服务在SSO成功后代表用户向认证服务获取JWT。
    *   **授权**：基于角色的访问控制 (RBAC) 或基于属性的访问控制 (ABAC)。例如，只有商品所有者才能编辑商品，管理员才能执行管理操作。
    *   **输入校验**：对所有外部输入进行严格校验（格式、长度、类型、范围），防止XSS, SQL注入等。使用Bean Validation (JSR 380) 等。
    *   **HTTPS**：全站启用HTTPS确保数据传输安全。
    *   **敏感数据**：密码使用强哈希算法（如BCrypt, scrypt）加盐存储；联系方式等可选择性加密存储或在展示时脱敏。
    *   **API安全**：防范重放攻击（通过timestamp, nonce），接口限流防刷。
    *   **依赖安全**：定期扫描项目依赖，更新有漏洞的库。
*   **可维护性**：
    *   遵循统一的编码规范和设计模式。
    *   各微服务独立开发、测试、部署，有清晰的边界和职责。
    *   提供Swagger/OpenAPI文档自动生成，并由API网关聚合。
    *   引入分布式链路追踪 (e.g., Zipkin, SkyWalking, OpenTelemetry) 监控服务调用链。
    *   完善的监控告警系统 (e.g., Prometheus + Grafana + Alertmanager)。
*   **数据流图 (高级)**
    ```
    +----------------+     +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |     |                |
    |  用户界面      +---->+  API网关       +---->+  认证服务      +---->+  用户服务      |
    |  (前端/小程序) |     |  (Gateway)     |     |  (Auth)        |     |  (User)        |
    |                |<----+                |<----+                |<----+                |
    +----------------+     +-------+--------+     +----------------+     +-------+--------+
                                   |                                             |
                                   | (请求路由)                                  | (用户信息)
                                   v                                             v
    +----------------+     +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |     |                |
    |  商品服务      |<#-->+  订单服务      +---->+  评价服务      |     |  消息服务      |
    |  (Product)     |     |  (Order)       |     |  (Review)      |     |  (Message)     |
    |                |<#-->+                |<----+                |     |                |
    +----------------+     +-------+--------+     +----------------+     +----------------+
            |                     |                      |                       |
            v                     v                      v                       v
    +----------------+     +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |     |                |
    |  商品数据库    |     |  订单数据库    |     |  评价数据库    |     |  消息数据库    |
    |  (MongoDB/MySQL)|     |  (MySQL)       |     |  (MySQL)       |     |  (MongoDB)     |
    |                |     |                |     |                |     |                |
    +----------------+     +----------------+     +----------------+     +----------------+
    (注: <#--> 表示双向依赖或通过消息队列的异步通信)
    ```
*   **安全架构图 (概念)**
    ```
    +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |
    |  客户端        +---->+  HTTPS/TLS     +---->+  WAF/API网关   |
    |  (浏览器/App)  |     |  加密传输      |     |  (请求过滤,限流)|
    |                |     |                |     |                |
    +----------------+     +----------------+     +-------+--------+
                                                          |
                                                          v
    +----------------------+     +----------------------+     +----------------------+
    |                      |     |                      |     |                      |
    |  认证服务 (Auth)     |<--->|  SSO系统 (校方)      |<--->|  微信登录服务        |
    |  (JWT颁发/校验)      |     |                      |     |                      |
    |                      |     |                      |     |                      |
    +---------+------------+     +----------------------+     +----------------------+
              | (JWT)
              v
    +----------------------+     +----------------------+     +----------------------+
    |                      |     |                      |     |                      |
    |  各业务微服务        +---->+  授权检查 (RBAC/ABAC)|---->+  敏感数据加密/脱敏   |
    |  (校验JWT权限)       |     |                      |     |  (存储/传输/展示)    |
    |                      |     |                      |     |                      |
    +----------------------+     +----------------------+     +----------------------+
              |
              v
    +----------------------+     +----------------------+     +----------------------+
    |                      |     |                      |     |                      |
    |  数据持久化 (DB)     +---->+  安全审计日志        +---->+  安全监控与告警      |
    |  (数据加密at-rest)   |     |  (操作记录)          |     |                      |
    |                      |     |                      |     |                      |
    +----------------------+     +----------------------+     +----------------------+
    ```
*   **容错架构图 (概念)**
    ```
    +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |
    |  服务A         +---->+  熔断/降级/重试+---->+  服务B         |
    |  (调用方)      |     |  (Resilience4J)  |     |  (被调用方)    |
    |                |<----+                  |<----+                |
    +----------------+     +-------+--------+     +----------------+
                                   | (调用链追踪)
                                   v
    +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |
    |  API网关       +---->+  服务注册发现  +---->+  配置中心      |
    |  (超时/重试)   |     |  (健康检查)    |     |  (动态配置)    |
    |                |     |                |     |                |
    +----------------+     +----------------+     +----------------+
                                   |
                                   v
    +----------------+     +----------------+     +----------------+
    |                |     |                |     |                |
    |  消息队列      +---->+  数据备份与恢复+---->+  监控告警系统  |
    |  (异步解耦)    |     |                |     |  (Prometheus)  |
    |                |     |                |     |                |
    +----------------+     +----------------+     +----------------+
    ```

**6 类的详细设计**

**6.1 User类 (隶属于用户服务)**

**6.1.1 描述**

代表平台的用户，存储用户的基本信息、认证信息和信用状态。

**6.1.2 属性**

| 属性名       | 类型                    | 描述                      |
| ------------ | ----------------------- | ------------------------- |
| userId       | Long                    | 用户唯一标识 (主键)       |
| studentId    | String                  | 学号 (唯一, 用于SSO关联)  |
| username     | String                  | 昵称 (可修改)             |
| passwordHash | String                  | 哈希后的密码 (若支持)     |
| avatarUrl    | String                  | 头像图片URL               |
| phone        | String                  | 手机号 (可选, 加密存储)   |
| email        | String                  | 邮箱 (可选)               |
| schoolCampus | String                  | 校区                      |
| buildingInfo | String                  | 楼栋信息                  |
| creditScore  | Integer                 | 信用分                    |
| status       | UserStatus (Enum)       | 用户状态 (ACTIVE, BANNED) |
| createdAt    | java.time.LocalDateTime | 注册时间                  |
| updatedAt    | java.time.LocalDateTime | 最后更新时间              |

**6.1.3 公有方法 (示例, 实际存在于Service/Controller层)**

| 方法名                                      | 返回值类型 (示例) | 描述                                           |
| ------------------------------------------- | ----------------- | ---------------------------------------------- |
| `registerWithSSO(ssoInfo)`                  | `UserDto`         | 通过SSO信息注册用户 (Controller层调用Service)  |
| `loginViaSSO(ssoTicket)`                    | `AuthResponseDto` | 通过SSO登录，返回JWT (Controller层调用Service) |
| `updateUserProfile(userId, profileDto)`     | `UserDto`         | 更新用户个人资料                               |
| `changePassword(userId, oldP, newP)`        | `void`            | 修改密码 (如果支持独立密码)                    |
| `updateCreditScore(userId, change, reason)` | `void`            | 更新信用分 (由评价服务或管理员操作触发)        |
| `getUserPublicProfile(userId)`              | `UserPublicDto`   | 获取用户公开信息                               |
| `getUserById(userId)`                       | `UserDto`         | 获取用户完整信息 (管理员或本人)                |

**6.1.4 私有方法 (示例, 存在于Service层或User实体内部)**

| 方法名                        | 返回值类型 | 描述                                    |
| ----------------------------- | ---------- | --------------------------------------- |
| `isValidPassword(password)`   | `boolean`  | 校验密码是否符合强度要求 (若有独立密码) |
| `hashPassword(rawPassword)`   | `String`   | 哈希密码 (若有独立密码)                 |
| `verifyPassword(raw, hashed)` | `boolean`  | 验证密码 (若有独立密码)                 |

**6.2 Product类 (隶属于商品服务)**

**6.2.1 描述**

代表用户发布的二手商品信息。

**6.2.2 属性**

| 属性名                   | 类型                    | 描述                                           |
| ------------------------ | ----------------------- | ---------------------------------------------- |
| productId                | Long                    | 商品唯一标识 (主键)                            |
| sellerId                 | Long                    | 卖家用户ID (关联User)                          |
| title                    | String                  | 商品标题                                       |
| description              | String                  | 商品详细描述                                   |
| price                    | java.math.BigDecimal    | 商品价格                                       |
| categoryId               | Long                    | 商品分类ID (关联Category)                      |
| status                   | ProductStatus (Enum)    | 商品状态 (AVAILABLE, RESERVED, SOLD, DELISTED) |
| imageUrls                | List<String>            | 商品图片URL列表                                |
| preferredTransactionMode | String                  | 偏好交易方式                                   |
| locationHint             | String                  | 校内大致位置                                   |
| postedAt                 | java.time.LocalDateTime | 发布时间                                       |
| updatedAt                | java.time.LocalDateTime | 最后更新时间                                   |

**6.2.3 公有方法 (示例, 实际存在于Service/Controller层)**

| 方法名                                        | 返回值类型 (示例)  | 描述                              |
| --------------------------------------------- | ------------------ | --------------------------------- |
| `publishNewProduct(sellerId, productDto)`     | `ProductDto`       | 发布新商品                        |
| `updateProductDetails(productId, productDto)` | `ProductDto`       | 更新商品信息 (仅限卖家或管理员)   |
| `delistProduct(productId, userId)`            | `void`             | 下架商品 (卖家或管理员)           |
| `markProductAsReserved(productId)`            | `void`             | 标记为已预订 (通常由订单服务触发) |
| `markProductAsSold(productId)`                | `void`             | 标记为已售出 (通常由订单服务触发) |
| `getProductById(productId)`                   | `ProductDto`       | 获取商品详情                      |
| `searchProducts(criteria, pageable)`          | `Page<ProductDto>` | 搜索商品                          |

**6.2.4 私有方法 (示例, 存在于Service层或Product实体内部)**

| 方法名                 | 返回值类型 | 描述                   |
| ---------------------- | ---------- | ---------------------- |
| `validatePrice(price)` | `boolean`  | 校验价格是否有效       |
| `canUpdate(userId)`    | `boolean`  | 判断当前用户是否能更新 |

**6.3 Order类 (隶属于订单服务)**

**6.3.1 描述**

代表买卖双方就某一商品达成的交易订单。

**6.3.2 属性**

| 属性名              | 类型                    | 描述                                                         |
| ------------------- | ----------------------- | ------------------------------------------------------------ |
| orderId             | Long                    | 订单唯一标识 (主键)                                          |
| buyerId             | Long                    | 买家用户ID (关联User)                                        |
| sellerId            | Long                    | 卖家用户ID (关联User)                                        |
| productId           | Long                    | 商品ID (关联Product)                                         |
| productSnapshot     | String (JSON)           | 商品快照 (下单时商品信息)                                    |
| orderAmount         | java.math.BigDecimal    | 订单金额                                                     |
| status              | OrderStatus (Enum)      | 订单状态 (PENDING_CONFIRMATION, PENDING_PAYMENT, PENDING_DELIVERY, COMPLETED, CANCELLED, DISPUTED) |
| createdAt           | java.time.LocalDateTime | 下单时间                                                     |
| updatedAt           | java.time.LocalDateTime | 订单状态最后更新时间                                         |
| transactionTime     | java.time.LocalDateTime | 实际交易完成时间 (可选)                                      |
| transactionLocation | String                  | 约定交易地点 (可选)                                          |

**6.3.3 公有方法 (示例, 实际存在于Service/Controller层)**

| 方法名                                        | 返回值类型 (示例) | 描述                            |
| --------------------------------------------- | ----------------- | ------------------------------- |
| `createOrder(buyerId, createOrderDto)`        | `OrderDto`        | 创建新订单                      |
| `confirmOrderBySeller(orderId, sellerId)`     | `OrderDto`        | 卖家确认订单                    |
| `cancelOrderByBuyer(orderId, buyerId)`        | `OrderDto`        | 买家取消订单 (特定条件下)       |
| `cancelOrderBySeller(orderId, sellerId)`      | `OrderDto`        | 卖家取消订单 (特定条件下)       |
| `markOrderAsPaid(orderId, paymentInfo)`       | `OrderDto`        | 标记订单为已付款 (若有在线支付) |
| `confirmDeliveryByBuyer(orderId, buyerId)`    | `OrderDto`        | 买家确认收货/完成面交           |
| `getOrderByIdForUser(orderId, userId)`        | `OrderDto`        | 获取用户相关订单详情            |
| `listOrdersForUser(userId, status, pageable)` | `Page<OrderDto>`  | 列出用户相关订单                |

**6.3.4 私有方法 (示例, 存在于Service层或Order实体内部)**

| 方法名                                    | 返回值类型 | 描述                                   |
| ----------------------------------------- | ---------- | -------------------------------------- |
| `canBeCancelledBy(userId, currentStatus)` | `boolean`  | 判断指定用户是否可以取消当前状态的订单 |
| `generateProductSnapshot(productInfo)`    | `String`   | 生成商品快照JSON                       |

**6.4 Review类 (隶属于评价服务)**

**6.4.1 描述**

代表用户对已完成交易的评价。

**6.4.2 属性**

| 属性名     | 类型                    | 描述                |
| ---------- | ----------------------- | ------------------- |
| reviewId   | Long                    | 评价唯一标识 (主键) |
| orderId    | Long                    | 关联的订单ID        |
| reviewerId | Long                    | 评价方用户ID        |
| revieweeId | Long                    | 被评价方用户ID      |
| rating     | Integer                 | 评分 (例如1-5星)    |
| comment    | String                  | 评价内容 (文本)     |
| createdAt  | java.time.LocalDateTime | 评价创建时间        |

**6.4.3 公有方法 (示例, 实际存在于Service/Controller层)**

| 方法名                                   | 返回值类型 (示例) | 描述                          |
| ---------------------------------------- | ----------------- | ----------------------------- |
| `submitReview(reviewerId, reviewDto)`    | `ReviewDto`       | 提交评价                      |
| `getReviewsForUser(userId, pageable)`    | `Page<ReviewDto>` | 获取用户收到的所有评价        |
| `getReviewsByOrder(orderId)`             | `List<ReviewDto>` | 获取订单的双方评价 (最多两条) |
| `deleteReviewByAdmin(reviewId, adminId)` | `void`            | 管理员删除违规评价            |

**6.5 Message类 (隶属于消息服务)**

**6.5.1 描述**
代表用户之间的私信或系统发送给用户的通知。

**6.5.2 属性**
| 属性名     | 类型                    | 描述                                    |
| ---------- | ----------------------- | --------------------------------------- |
| messageId  | Long                    | 消息唯一标识 (主键)                     |
| senderId   | Long                    | 发送方用户ID (系统通知时可为特殊值)     |
| receiverId | Long                    | 接收方用户ID                            |
| content    | String                  | 消息内容                                |
| type       | MessageType (Enum)      | 消息类型 (PRIVATE, SYSTEM_NOTIFICATION) |
| readStatus | Boolean                 | 是否已读                                |
| sentTime   | java.time.LocalDateTime | 发送时间                                |

**6.5.3 公有方法 (示例, 实际存在于Service/Controller层)**
| 方法名                                        | 返回值类型 (示例)  | 描述                        |
| --------------------------------------------- | ------------------ | --------------------------- |
| `sendMessage(senderId, sendMessageDto)`       | `MessageDto`       | 发送私信                    |
| `sendSystemNotification(receiverId, content)` | `void`             | 发送系统通知                |
| `getMessagesForUser(userId, pageable)`        | `Page<MessageDto>` | 获取用户的消息列表 (会话式) |
| `markMessagesAsRead(userId, messageIds)`      | `void`             | 标记消息为已读              |
| `countUnreadMessages(userId)`                 | `Integer`          | 获取用户未读消息数          |

**7 用例实现的详细设计**

**7.1 UC01 - 用户注册与登录**
    **7.1.1 功能说明**
    **7.1.2 界面设计**
    **7.1.3 参与类**
    **7.1.4 交互设计**

**7.2 UC02 - 发布二手商品**
    **7.2.1 功能说明**
    **7.2.2 界面设计**
    **7.2.3 参与类**
    **7.2.4 交互设计**

**7.3 UC03 - 浏览与搜索商品**
    **7.3.1 功能说明**
    **7.3.2 界面设计**
    **7.3.3 参与类**
    **7.3.4 交互设计**

**7.4 UC04 - 购买商品**
    **7.4.1 功能说明**
    **7.4.2 界面设计**
    **7.4.3 参与类**
    **7.4.4 交互设计**

**7.5 UC05 - 评价交易**
    **7.5.1 功能说明**
    **7.5.2 界面设计**
    **7.5.3 参与类**
    **7.5.4 交互设计**

*(其他用例，如发送私信（UC06）、管理订单（UC07）的详细实现设计应参照《详细用例说明.md》文件补充)*

**8 数据库设计**

**8.1 ER图**
```
+----------------+                  +----------------+
|     User       |                  |    Category    |
+----------------+                  +----------------+
| PK userId      |                  | PK categoryId  |
| studentId      |                  | name           |
| username       |                  | parentId       |
| passwordHash   |                  | level          |
| avatarUrl      |                  | createdAt      |
| phone          |                  +-------+--------+
| email          |                          |
| schoolCampus   |                          |
| buildingInfo   |                          |
| creditScore    |                          |
| status         |                          |
| createdAt      |                          |
| updatedAt      |                          |
+-------+--------+                          |
        |                                   |
        |                                   |
        |                                   |
        |        +----------------+         |
        |        |    Product     |         |
        +------->+----------------+<--------+
        |        | PK productId   |
        |        | FK sellerId    |
        |        | title          |
        |        | description    |
        |        | price          |
        |        | FK categoryId  |
        |        | status         |
        |        | imageUrls      |
        |        | preferredMode  |
        |        | locationHint   |
        |        | postedAt       |
        |        | updatedAt      |
        |        +-------+--------+
        |                |
        |                |
+-------v--------+       |       +----------------+
|   Favorite     |       |       |    Review      |
+----------------+       |       +----------------+
| PK favoriteId  |       |       | PK reviewId    |
| FK userId      |       |       | FK orderId     |
| FK productId   |       |       | FK reviewerId  |
| createdAt      |       |       | FK revieweeId  |
+----------------+       |       | rating         |
                         |       | comment        |
                         |       | createdAt      |
                         |       +-------+--------+
                         |               |
                         |               |
                  +------v-------+       |
                  |    Order     |       |
                  +----------------+     |
                  | PK orderId    |     |
                  | FK buyerId    +<----+ (Review.orderId -> Order.orderId, Review.reviewerId/revieweeId -> User.userId)
                  | FK sellerId   |
                  | FK productId  |
                  | productSnapshot|
                  | orderAmount   |
                  | status        |
                  | createdAt     |
                  | updatedAt     |
                  | transactionTime|
                  | transactionLoc|
                  +-------+--------+
                          |
                          |
                  +-------v--------+     +----------------+
                  |    Message     |     | CreditHistory  |
                  +----------------+     +----------------+
                  | PK messageId   |     | PK historyId   |
                  | FK senderId    |     | FK userId      |
                  | FK receiverId  |     | changeAmount   |
                  | content        |     | reason         |
                  | sentTime       |     | sourceType     |
                  | type           |     | sourceId       |
                  | readStatus     |     | createdAt      |
                  +----------------+     +----------------+
```

**8.2 数据库表结构设计**

*(以下表格参照《数据库设计.md》内容，已转换为课程设计报告要求的格式)*

**8.2.1 用户表 (users)**
**数据库表/视图ID:** `users`
**数据库表/视图名称:** `用户信息表`

| 序号 | 字段 ID         | 字段名称     | 类型           | 是否为空 | 长度 | PK/FK | 取值范围      | 说明       | 备注                               |
| :--- | :-------------- | :----------- | :------------- | :------- | :--- | :---- | :------------ | :--------- | :--------------------------------- |
| 1    | `user_id`       | `用户ID`     | `BIGINT`       | 否       |      | PK    | 自增          | 用户ID     | 主键, AUTO_INCREMENT               |
| 2    | `student_id`    | `学号/工号`  | `VARCHAR(20)`  | 否       | 20   |       |               | 学号/工号  | UNIQUE, NOT NULL, `idx_student_id` |
| 3    | `username`      | `用户昵称`   | `VARCHAR(50)`  | 否       | 50   |       |               | 用户昵称   | NOT NULL                           |
| 4    | `password_hash` | `密码哈希值` | `VARCHAR(255)` | 否       | 255  |       |               | 密码哈希值 | NOT NULL (如果支持独立密码)        |
| 5    | `avatar_url`    | `头像URL`    | `VARCHAR(255)` | 是       | 255  |       |               | 头像URL    |                                    |
| 6    | `phone`         | `手机号`     | `VARCHAR(20)`  | 是       | 20   |       |               | 手机号     | (加密存储)                         |
| 7    | `email`         | `邮箱`       | `VARCHAR(100)` | 是       | 100  |       |               | 邮箱       | (加密存储)                         |
| 8    | `school_campus` | `校区`       | `VARCHAR(50)`  | 否       | 50   |       |               | 校区       | NOT NULL                           |
| 9    | `building_info` | `楼栋信息`   | `VARCHAR(100)` | 是       | 100  |       |               | 楼栋信息   |                                    |
| 10   | `credit_score`  | `信用分`     | `INT`          | 否       |      |       | 初始100       | 信用分     | DEFAULT 100, `idx_credit_score`    |
| 11   | `status`        | `状态`       | `TINYINT`      | 否       |      |       | 1:正常,0:禁用 | 状态       | DEFAULT 1, `idx_status`            |
| 12   | `created_at`    | `创建时间`   | `TIMESTAMP`    | 否       |      |       |               | 创建时间   | DEFAULT NOW()                      |
| 13   | `updated_at`    | `更新时间`   | `TIMESTAMP`    | 否       |      |       |               | 更新时间   | DEFAULT NOW() ON UPDATE NOW()      |

**8.2.2 商品分类表 (categories)**
**数据库表/视图ID:** `categories`
**数据库表/视图名称:** `商品分类表`

| 序号 | 字段 ID       | 字段名称   | 类型          | 是否为空 | 长度 | PK/FK | 取值范围 | 说明     | 备注                          |
| :--- | :------------ | :--------- | :------------ | :------- | :--- | :---- | :------- | :------- | :---------------------------- |
| 1    | `category_id` | `分类ID`   | `BIGINT`      | 否       |      | PK    | 自增     | 分类ID   | 主键, AUTO_INCREMENT          |
| 2    | `name`        | `分类名称` | `VARCHAR(50)` | 否       | 50   |       |          | 分类名称 | NOT NULL                      |
| 3    | `parent_id`   | `父分类ID` | `BIGINT`      | 是       |      | FK    |          | 父分类ID | DEFAULT NULL, `idx_parent_id` |
| 4    | `level`       | `分类层级` | `TINYINT`     | 否       |      |       | 1,2,3... | 分类层级 | DEFAULT 1                     |
| 5    | `created_at`  | `创建时间` | `TIMESTAMP`   | 否       |      |       |          | 创建时间 | DEFAULT NOW()                 |

**8.2.3 商品表 (products)**
**数据库表/视图ID:** `products`
**数据库表/视图名称:** `商品表`

| 序号 | 字段 ID                      | 字段名称       | 类型            | 是否为空 | 长度 | PK/FK | 取值范围                        | 说明         | 备注                                                         |
| :--- | :--------------------------- | :------------- | :-------------- | :------- | :--- | :---- | :------------------------------ | :----------- | :----------------------------------------------------------- |
| 1    | `product_id`                 | `商品ID`       | `BIGINT`        | 否       |      | PK    | 自增                            | 商品ID       | 主键, AUTO_INCREMENT                                         |
| 2    | `seller_id`                  | `卖家ID`       | `BIGINT`        | 否       |      | FK    |                                 | 卖家ID       | FK, NOT NULL, `idx_seller_id`, FOREIGN KEY (seller_id) REFERENCES users(user_id) |
| 3    | `title`                      | `商品标题`     | `VARCHAR(100)`  | 否       | 100  |       |                                 | 商品标题     | NOT NULL, FULLTEXT INDEX idx_title_description (title, description) |
| 4    | `description`                | `商品描述`     | `TEXT`          | 否       |      |       |                                 | 商品描述     | NOT NULL                                                     |
| 5    | `price`                      | `价格`         | `DECIMAL(10,2)` | 否       |      |       |                                 | 价格         | NOT NULL                                                     |
| 6    | `category_id`                | `分类ID`       | `BIGINT`        | 否       |      | FK    |                                 | 分类ID       | FK, NOT NULL, `idx_category_id`, FOREIGN KEY (category_id) REFERENCES categories(category_id) |
| 7    | `status`                     | `状态`         | `TINYINT`       | 否       |      |       | 1:在售,2:已预订,3:已售出,0:下架 | 状态         | DEFAULT 1, `idx_status`                                      |
| 8    | `image_urls`                 | `图片URL列表`  | `JSON`          | 否       |      |       |                                 | 图片URL列表  | NOT NULL                                                     |
| 9    | `preferred_transaction_mode` | `偏好交易方式` | `VARCHAR(50)`   | 否       | 50   |       |                                 | 偏好交易方式 | NOT NULL                                                     |
| 10   | `location_hint`              | `校内位置提示` | `VARCHAR(255)`  | 否       | 255  |       |                                 | 校内位置提示 | NOT NULL                                                     |
| 11   | `posted_at`                  | `发布时间`     | `TIMESTAMP`     | 否       |      |       |                                 | 发布时间     | DEFAULT NOW(), `idx_posted_at`                               |
| 12   | `updated_at`                 | `更新时间`     | `TIMESTAMP`     | 否       |      |       |                                 | 更新时间     | DEFAULT NOW() ON UPDATE NOW()                                |

**8.2.4 收藏表 (favorites)**
**数据库表/视图ID:** `favorites`
**数据库表/视图名称:** `收藏表`

| 序号 | 字段 ID       | 字段名称   | 类型        | 是否为空 | 长度 | PK/FK | 取值范围 | 说明     | 备注                                                         |
| :--- | :------------ | :--------- | :---------- | :------- | :--- | :---- | :------- | :------- | :----------------------------------------------------------- |
| 1    | `favorite_id` | `收藏ID`   | `BIGINT`    | 否       |      | PK    | 自增     | 收藏ID   | 主键, AUTO_INCREMENT                                         |
| 2    | `user_id`     | `用户ID`   | `BIGINT`    | 否       |      | FK    |          | 用户ID   | FK, NOT NULL, `idx_user_id`, UNIQUE INDEX idx_user_product (user_id, product_id), FOREIGN KEY (user_id) REFERENCES users(user_id) |
| 3    | `product_id`  | `商品ID`   | `BIGINT`    | 否       |      | FK    |          | 商品ID   | FK, NOT NULL, `idx_product_id`, FOREIGN KEY (product_id) REFERENCES products(product_id) |
| 4    | `created_at`  | `创建时间` | `TIMESTAMP` | 否       |      |       |          | 创建时间 | DEFAULT NOW()                                                |

**8.2.5 订单表 (orders)**
**数据库表/视图ID:** `orders`
**数据库表/视图名称:** `订单表`

| 序号 | 字段 ID                | 字段名称       | 类型            | 是否为空 | 长度 | PK/FK | 取值范围                                              | 说明         | 备注                                                         |
| :--- | :--------------------- | :------------- | :-------------- | :------- | :--- | :---- | :---------------------------------------------------- | :----------- | :----------------------------------------------------------- |
| 1    | `order_id`             | `订单ID`       | `BIGINT`        | 否       |      | PK    | 自增                                                  | 订单ID       | 主键, AUTO_INCREMENT                                         |
| 2    | `buyer_id`             | `买家ID`       | `BIGINT`        | 否       |      | FK    |                                                       | 买家ID       | FK, NOT NULL, `idx_buyer_id`, FOREIGN KEY (buyer_id) REFERENCES users(user_id) |
| 3    | `seller_id`            | `卖家ID`       | `BIGINT`        | 否       |      | FK    |                                                       | 卖家ID       | FK, NOT NULL, `idx_seller_id`, FOREIGN KEY (seller_id) REFERENCES users(user_id) |
| 4    | `product_id`           | `商品ID`       | `BIGINT`        | 否       |      | FK    |                                                       | 商品ID       | FK, NOT NULL, `idx_product_id`, FOREIGN KEY (product_id) REFERENCES products(product_id) |
| 5    | `product_snapshot`     | `商品快照`     | `JSON`          | 否       |      |       |                                                       | 商品快照     | NOT NULL                                                     |
| 6    | `order_amount`         | `订单金额`     | `DECIMAL(10,2)` | 否       |      |       |                                                       | 订单金额     | NOT NULL                                                     |
| 7    | `status`               | `状态`         | `TINYINT`       | 否       |      |       | 1:待确认,2:待付款,3:待收货,4:已完成,0:已取消,5:纠纷中 | 状态         | DEFAULT 1, `idx_status`                                      |
| 8    | `created_at`           | `创建时间`     | `TIMESTAMP`     | 否       |      |       |                                                       | 创建时间     | DEFAULT NOW(), `idx_created_at`                              |
| 9    | `updated_at`           | `更新时间`     | `TIMESTAMP`     | 否       |      |       |                                                       | 更新时间     | DEFAULT NOW() ON UPDATE NOW()                                |
| 10   | `transaction_time`     | `交易完成时间` | `TIMESTAMP`     | 是       |      |       |                                                       | 交易完成时间 | DEFAULT NULL                                                 |
| 11   | `transaction_location` | `交易地点`     | `VARCHAR(255)`  | 是       | 255  |       |                                                       | 交易地点     | DEFAULT NULL                                                 |

**8.2.6 评价表 (reviews)**
**数据库表/视图ID:** `reviews`
**数据库表/视图名称:** `评价表`

| 序号 | 字段 ID       | 字段名称     | 类型           | 是否为空 | 长度 | PK/FK | 取值范围 | 说明       | 备注                                                         |
| :--- | :------------ | :----------- | :------------- | :------- | :--- | :---- | :------- | :--------- | :----------------------------------------------------------- |
| 1    | `review_id`   | `评价ID`     | `BIGINT`       | 否       |      | PK    | 自增     | 评价ID     | 主键, AUTO_INCREMENT                                         |
| 2    | `order_id`    | `订单ID`     | `BIGINT`       | 否       |      | FK    |          | 订单ID     | FK, NOT NULL, `idx_order_id`, UNIQUE INDEX idx_order_reviewer (order_id, reviewer_id), FOREIGN KEY (order_id) REFERENCES orders(order_id) |
| 3    | `reviewer_id` | `评价方ID`   | `BIGINT`       | 否       |      | FK    |          | 评价方ID   | FK, NOT NULL, `idx_reviewer_id`, FOREIGN KEY (reviewer_id) REFERENCES users(user_id) |
| 4    | `reviewee_id` | `被评价方ID` | `BIGINT`       | 否       |      | FK    |          | 被评价方ID | FK, NOT NULL, `idx_reviewee_id`, FOREIGN KEY (reviewee_id) REFERENCES users(user_id) |
| 5    | `rating`      | `评分(1-5)`  | `TINYINT`      | 否       |      |       | 1-5      | 评分       | NOT NULL                                                     |
| 6    | `comment`     | `评价内容`   | `VARCHAR(500)` | 否       | 500  |       |          | 评价内容   | NOT NULL                                                     |
| 7    | `created_at`  | `创建时间`   | `TIMESTAMP`    | 否       |      |       |          | 创建时间   | DEFAULT NOW()                                                |

**8.2.7 消息表 (messages)**
**数据库表/视图ID:** `messages`
**数据库表/视图名称:** `消息表`

| 序号 | 字段 ID       | 字段名称   | 类型        | 是否为空 | 长度 | PK/FK | 取值范围          | 说明     | 备注                                                         |
| :--- | :------------ | :--------- | :---------- | :------- | :--- | :---- | :---------------- | :------- | :----------------------------------------------------------- |
| 1    | `message_id`  | `消息ID`   | `BIGINT`    | 否       |      | PK    | 自增              | 消息ID   | 主键, AUTO_INCREMENT                                         |
| 2    | `sender_id`   | `发送方ID` | `BIGINT`    | 否       |      | FK    |                   | 发送方ID | FK, NOT NULL, `idx_sender_id`, FOREIGN KEY (sender_id) REFERENCES users(user_id) |
| 3    | `receiver_id` | `接收方ID` | `BIGINT`    | 否       |      | FK    |                   | 接收方ID | FK, NOT NULL, `idx_receiver_id`, FOREIGN KEY (receiver_id) REFERENCES users(user_id) |
| 4    | `content`     | `消息内容` | `TEXT`      | 否       |      |       |                   | 消息内容 | NOT NULL                                                     |
| 5    | `sent_time`   | `发送时间` | `TIMESTAMP` | 否       |      |       |                   | 发送时间 | DEFAULT NOW(), `idx_sent_time`                               |
| 6    | `type`        | `类型`     | `TINYINT`   | 否       |      |       | 1:私信,2:系统通知 | 类型     | DEFAULT 1                                                    |
| 7    | `read_status` | `已读状态` | `BOOLEAN`   | 否       |      |       |                   | 已读状态 | DEFAULT FALSE, `idx_read_status`                             |

**8.2.8 信用历史表 (credit_history)**
**数据库表/视图ID:** `credit_history`
**数据库表/视图名称:** `信用历史表`

| 序号 | 字段 ID         | 字段名称     | 类型           | 是否为空 | 长度 | PK/FK | 取值范围                   | 说明       | 备注                                                         |
| :--- | :-------------- | :----------- | :------------- | :------- | :--- | :---- | :------------------------- | :--------- | :----------------------------------------------------------- |
| 1    | `history_id`    | `历史记录ID` | `BIGINT`       | 否       |      | PK    | 自增                       | 历史记录ID | 主键, AUTO_INCREMENT                                         |
| 2    | `user_id`       | `用户ID`     | `BIGINT`       | 否       |      | FK    |                            | 用户ID     | FK, NOT NULL, `idx_user_id`, FOREIGN KEY (user_id) REFERENCES users(user_id) |
| 3    | `change_amount` | `变更分值`   | `INT`          | 否       |      |       |                            | 变更分值   | NOT NULL                                                     |
| 4    | `reason`        | `变更原因`   | `VARCHAR(255)` | 否       | 255  |       |                            | 变更原因   | NOT NULL                                                     |
| 5    | `source_type`   | `来源类型`   | `TINYINT`      | 否       |      |       | 1:交易,2:评价,3:管理员调整 | 来源类型   | NOT NULL                                                     |
| 6    | `source_id`     | `来源ID`     | `BIGINT`       | 是       |      |       | (订单ID, 评价ID等)         | 来源ID     | DEFAULT NULL                                                 |
| 7    | `created_at`    | `创建时间`   | `TIMESTAMP`    | 否       |      |       |                            | 创建时间   | DEFAULT NOW(), `idx_created_at`                              |

**8.3 数据库分库分表策略**

考虑到校园二手交易平台的特点和数据量，初期可以采用单库多表的方式，随着系统规模扩大，可以考虑以下分库分表策略：

**8.3.1 垂直分库**

- **用户服务数据库**：存储用户表 (`users`)、信用历史表 (`credit_history`)。
- **商品服务数据库**：存储商品表 (`products`)、分类表 (`categories`)、收藏表 (`favorites`)。
- **订单服务数据库**：存储订单表 (`orders`)。
- **评价服务数据库**：存储评价表 (`reviews`)。
- **消息服务数据库**：存储消息表 (`messages`)。

**8.3.2 水平分表**

当单表数据量达到一定规模时（如百万级），可以考虑按照以下策略进行水平分表：

- **商品表 (`products`)**：可以考虑按 `seller_id` 哈希分片，或者如果冷热数据明显，按 `posted_at` 时间范围分表。
- **订单表 (`orders`)**：按照 `buyer_id` 或 `seller_id` 哈希分表，或者按 `created_at` 时间范围分表（例如按月或季度）。
- **消息表 (`messages`)**：按照 `receiver_id` 哈希分表，以保证同一用户的消息落在同一分片，便于查询。
- **评价表 (`reviews`)**：按照 `order_id` 哈希分表，或者按 `reviewee_id` 分表。

**8.3.3 读写分离**

对于查询频繁的表（如商品表、用户表），可以配置主从复制，实现读写分离：
- 主库负责写操作和实时性要求高的读操作。
- 从库负责大部分读操作，减轻主库压力。

**8.3.4 缓存策略**

- 使用Redis等内存数据库缓存热点数据：
    - 热门商品信息、商品详情。
    - 用户基本信息和信用分。
    - 商品分类信息。
    - 用户会话信息 (JWT黑名单，或SSO的session映射)。
    - 计数器类数据（如商品浏览量、未读消息数）。
- 缓存更新策略：Cache-Aside Pattern，或考虑使用Canal等工具同步数据库变更到缓存。

**9 系统测试计划**
*(参照《系统测试计划.md》文件内容，此处仅列出大纲，详细内容已在源文件中提供)*

**9.1 测试策略概述**
**9.2 测试环境**
    9.2.1 开发环境测试
    9.2.2 测试环境
    9.2.3 预生产环境
**9.3 测试类型**
    9.3.1 单元测试
    9.3.2 集成测试
    9.3.3 系统测试
    9.3.4 用户验收测试 (UAT)
**9.4 测试用例设计** (示例已在源文件提供)
    9.4.1 用户服务测试用例示例
    9.4.2 商品服务测试用例示例
    9.4.3 订单服务测试用例示例
**9.5 性能测试计划**
    9.5.1 负载测试
    9.5.2 压力测试
    9.5.3 耐久性测试
**9.6 缺陷跟踪与管理**
**9.7 测试进度与里程碑**
**9.8 测试风险与缓解策略**
**9.9 测试完成标准**
**9.10 测试报告模板**

---

**10 微信小程序适配指导**

将现有的基于微服务架构的校园二手交易平台适配到微信小程序，主要涉及前端的重构和后端接口的调整与复用。

**10.1 总体架构调整**

*   **前端层**：新增微信小程序端。小程序将作为用户与系统交互的又一个入口。
*   **API网关层**：依然是所有请求的入口。小程序通过 `wx.request` API 调用网关暴露的接口。
*   **认证授权服务**：需要进行扩展以支持微信登录。
    *   小程序通过 `wx.login()` 获取 `code`。
    *   小程序将 `code` 发送给认证授权服务。
    *   认证授权服务使用 `code`、`AppID`、`AppSecret` 调用微信接口服务换取 `session_key` 和 `openid` (以及 `unionid`，如果应用涉及多个微信平台应用)。
    *   认证授权服务根据 `openid` (或 `unionid`) 查找或创建平台用户，并绑定微信身份。
    *   认证授权服务生成JWT，返回给小程序。小程序后续请求API网关时携带此JWT。
*   **其他微服务**：大部分业务逻辑和接口可以复用。可能需要针对小程序特性（如推送通知）进行少量适配。

**10.2 小程序端开发要点**

*   **技术选型**：
    *   原生小程序开发 (WXML, WXSS, JavaScript)。
    *   或者使用小程序框架，如 Taro, uni-app, mpvue (这些框架允许使用React/Vue语法开发，并编译到多端，包括微信小程序)。
*   **UI/UX设计**：
    *   遵循微信小程序设计规范，提供简洁、易用的界面。
    *   利用微信提供的原生组件 (如 `button`, `scroll-view`, `swiper`, `icon` 等)。
    *   充分考虑移动端交互特性，如滑动、点击区域大小。
*   **核心功能实现**：
    *   **用户登录/注册**：实现微信一键登录流程。首次登录需引导用户授权获取昵称、头像等信息，并与平台账户绑定（或创建新账户）。
    *   **商品浏览与搜索**：
        *   列表页：使用 `scroll-view` 实现上拉加载更多/下拉刷新。
        *   搜索框：`input` 组件。
        *   商品卡片：自定义组件。
    *   **商品发布**：
        *   表单：`form`, `input`, `textarea`, `picker` (分类选择)。
        *   图片上传：`wx.chooseMedia` (或 `wx.chooseImage`) 选择图片，`wx.uploadFile` 上传到后端。
    *   **订单与交易**：
        *   订单列表、订单详情。
        *   与卖家沟通：可以引导至小程序客服消息，或集成第三方即时通讯SDK（如果平台消息服务支持WebSocket并能适配小程序）。
        *   支付：如果平台支持在线支付，优先集成微信支付 (`wx.requestPayment`)。
    *   **消息通知**：
        *   利用微信小程序订阅消息能力，在关键事件（如订单状态变更、新私信）发生时，由后端触发向用户发送服务通知。
        *   私信功能：如果后端消息服务支持WebSocket，小程序端可以使用 `wx.connectSocket` 实现实时通讯。
    *   **个人中心**：我的发布、我的订单、我的收藏、信用分等。
*   **API请求封装**：
    *   封装 `wx.request`，统一处理请求头 (如 `Authorization`携带JWT)、基地址、错误处理、loading状态等。
*   **状态管理**：
    *   简单场景下，使用页面 `data` 和组件 `properties`。
    *   复杂场景，可引入轻量级状态管理库 (如 MobX 的小程序版本) 或自行实现事件总线。
*   **组件化开发**：将可复用的UI和逻辑封装成自定义组件，提高开发效率和可维护性。
*   **性能优化**：
    *   合理使用 `setData`，避免频繁或大数据量的更新。
    *   图片懒加载、分包加载。
    *   代码包体积优化。
*   **获取用户授权**：
    *   对于地理位置 (`wx.getLocation`)、用户信息 (`wx.getUserProfile`) 等敏感权限，需要在合适的时机向用户请求授权。

**10.3 后端微服务适配**

*   **认证授权服务**：
    *   新增处理微信登录的接口 (接收 `code`，返回JWT)。
    *   用户表中可能需要增加 `wx_openid`, `wx_unionid` 等字段用于微信用户身份的关联。
*   **消息服务**：
    *   如果需要实现小程序内的实时私信，消息服务需要支持WebSocket连接，并处理来自小程序客户端的连接。
    *   集成微信订阅消息推送能力，提供接口供业务服务调用以触发消息发送。
*   **支付服务 (如果集成微信支付)**：
    *   与微信支付API对接，实现统一下单、支付结果通知处理、退款等。
*   **图片/文件存储服务**：
    *   需要确保小程序上传的文件能被正确接收和存储。
*   **API接口调整**：
    *   检查现有API接口是否完全满足小程序需求，可能需要新增或调整部分接口的输入输出参数。
    *   例如，某些列表接口可能需要支持更灵活的分页和排序参数。
    *   地理位置相关的筛选可能需要后端支持基于经纬度的范围查询。

**10.4 开发与部署流程**

1.  **小程序AppID申请**：在微信公众平台注册小程序并获取AppID。
2.  **开发工具**：使用微信开发者工具进行开发和调试。
3.  **后端接口联调**：小程序前端与后端API网关进行接口联调。
4.  **测试**：在不同设备和微信版本上进行充分测试。
5.  **发布**：通过微信开发者工具提交代码审核，审核通过后即可发布上线。

**总结**：
将现有系统适配到微信小程序，核心在于构建新的小程序前端，并对认证授权等少数后端服务进行扩展以支持微信生态。大部分后端业务逻辑和API可以高度复用，体现了微服务架构的灵活性和可扩展性。关键在于理解小程序的技术特性和用户体验要求，进行针对性的设计和开发。

​																																																																																																																																																																																														