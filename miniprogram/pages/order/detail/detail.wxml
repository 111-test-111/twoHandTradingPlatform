<view class="container">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <scroll-view class="content-scroll" scroll-y="true" enhanced="true" wx:if="{{!loading}}">
    <!-- å•†å“ä¿¡æ¯å¡ç‰‡ -->
    <view class="card product-card">
      <view class="card-header">
        <text class="card-title">ğŸ“¦ å•†å“ä¿¡æ¯</text>
      </view>
      <view class="product-info">
        <image class="product-image" src="{{product.images[0]}}" mode="aspectFill"></image>
        
        <view class="product-details">
          <view class="product-table-row">
            <text class="product-table-label">å•†å“åç§°</text>
            <text class="product-table-value product-title">{{product.title}}</text>
          </view>
          
          <view class="product-table-row">
            <text class="product-table-label">ä»·æ ¼</text>
            <text class="product-table-value product-price">Â¥{{product.price}}</text>
          </view>
          
          <view class="product-table-row">
            <text class="product-table-label">çŠ¶æ€</text>
            <text class="product-table-value">
              <text class="product-status">{{product.status === 'available' ? 'åœ¨å”®' : (product.status === 'reserved' ? 'é¢„å®šä¸­' : 'å·²å”®å‡º')}}</text>
            </text>
          </view>
          
          <view class="product-table-row" wx:if="{{product.condition}}">
            <text class="product-table-label">æ–°æ—§ç¨‹åº¦</text>
            <text class="product-table-value">
              <text class="tag">{{product.condition}}</text>
            </text>
          </view>
          
          <view class="product-table-row" wx:if="{{product.campus}}">
            <text class="product-table-label">æ ¡åŒº</text>
            <text class="product-table-value">
              <text class="tag">{{product.campus}}</text>
            </text>
          </view>
          
          <view class="product-table-row" wx:if="{{product.category}}">
            <text class="product-table-label">åˆ†ç±»</text>
            <text class="product-table-value">
              <text class="tag">{{product.category}}</text>
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¹°å®¶è§†è§’ï¼šæ˜¾ç¤ºå–å®¶ä¿¡æ¯ -->
    <view wx:if="{{action === 'buy' || (action === 'view' && isBuyer)}}" class="card seller-card">
      <view class="card-header">
        <text class="card-title">ğŸ‘¤ å–å®¶ä¿¡æ¯</text>
      </view>
      <view class="seller-info">
        <view class="seller-avatar-container">
          <image class="seller-avatar" src="{{seller.avatar || '/assets/images/placeholder.png'}}" mode="aspectFill"></image>
        </view>
        
        <view class="seller-table">
          <view class="seller-table-row">
            <text class="seller-table-label">æ˜µç§°</text>
            <text class="seller-table-value seller-name">{{seller.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
          </view>
          
          <view class="seller-table-row">
            <text class="seller-table-label">ä¿¡ç”¨è¯„åˆ†</text>
            <text class="seller-table-value seller-rating">{{seller.creditScore || 100}}åˆ†</text>
          </view>
          
          <view class="seller-table-row" wx:if="{{sellerStats}}">
            <text class="seller-table-label">æˆäº¤è®°å½•</text>
            <text class="seller-table-value seller-stats">{{sellerStats.soldProducts || 0}}ç¬”æˆäº¤ï¼Œå¥½è¯„ç‡ {{sellerStats.positiveRate || 100}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å–å®¶è§†è§’ï¼šæ˜¾ç¤ºä¹°å®¶ä¿¡æ¯ -->
    <view wx:if="{{action === 'view' && isSeller}}" class="card buyer-card">
      <view class="card-header">
        <text class="card-title">ğŸ›’ ä¹°å®¶ä¿¡æ¯</text>
      </view>
      <view class="buyer-info">
        <view class="buyer-table">
          <view class="buyer-table-row">
            <text class="buyer-table-label">å§“å</text>
            <text class="buyer-table-value">{{buyerInfo.name}}</text>
          </view>
          
          <view class="buyer-table-row">
            <text class="buyer-table-label">è”ç³»ç”µè¯</text>
            <text class="buyer-table-value">{{buyerInfo.phone}}</text>
          </view>
          
          <view class="buyer-table-row">
            <text class="buyer-table-label">æ‰€åœ¨æ ¡åŒº</text>
            <text class="buyer-table-value">{{buyerInfo.campus}}</text>
          </view>
          
          <view class="buyer-table-row">
            <text class="buyer-table-label">è¯¦ç»†åœ°å€</text>
            <text class="buyer-table-value">{{buyerInfo.address}}</text>
          </view>
          
          <view class="buyer-table-row">
            <text class="buyer-table-label">æ”¯ä»˜æ–¹å¼</text>
            <text class="buyer-table-value">{{buyerInfo.paymentMethod}}</text>
          </view>
          
          <view class="buyer-table-row">
            <text class="buyer-table-label">é¢„ä»˜é‡‘é¢</text>
            <text class="buyer-table-value">Â¥{{buyerInfo.payAmount}}</text>
          </view>
          
          <view class="buyer-table-row" wx:if="{{buyerInfo.message}}">
            <text class="buyer-table-label">ä¹°å®¶ç•™è¨€</text>
            <text class="buyer-table-value">{{buyerInfo.message}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ›å»ºè®¢å•æ¨¡å¼ï¼šä¹°å®¶ä¿¡æ¯è¡¨å• -->
    <view wx:if="{{action === 'buy'}}" class="card buyer-form-card">
      <view class="card-header">
        <text class="card-title">âœï¸ ä¹°å®¶ä¿¡æ¯</text>
        <text class="card-subtitle">è¯·å®Œå–„æ‚¨çš„ä¿¡æ¯ä»¥ä¾¿å–å®¶ä¸æ‚¨è”ç³»</text>
      </view>

      <view class="form-group">
        <view class="form-item">
          <text class="form-label">å§“å <text class="required">*</text></text>
          <input class="form-input {{errors.name ? 'input-error' : ''}}" 
                 placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" 
                 value="{{buyerInfo.name}}" 
                 bindinput="onInputName" />
          <text class="error-text" wx:if="{{errors.name}}">{{errors.name}}</text>
        </view>

        <view class="form-item">
          <text class="form-label">è”ç³»ç”µè¯ <text class="required">*</text></text>
          <input class="form-input {{errors.phone ? 'input-error' : ''}}" 
                 type="number" 
                 placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·ç " 
                 value="{{buyerInfo.phone}}" 
                 bindinput="onInputPhone" />
          <text class="error-text" wx:if="{{errors.phone}}">{{errors.phone}}</text>
        </view>

        <view class="form-item">
          <text class="form-label">æ ¡åŒº <text class="required">*</text></text>
          <picker mode="selector" 
                  range="{{campusOptions}}" 
                  value="{{selectedCampusIndex}}" 
                  bindchange="onCampusChange" 
                  class="{{errors.campus ? 'picker-error' : ''}}">
            <view class="picker-view">
              <text>{{selectedCampusIndex >= 0 ? campusOptions[selectedCampusIndex] : 'è¯·é€‰æ‹©æ ¡åŒº'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
          <text class="error-text" wx:if="{{errors.campus}}">{{errors.campus}}</text>
        </view>

        <view class="form-item">
          <text class="form-label">è¯¦ç»†åœ°å€ <text class="required">*</text></text>
          <input class="form-input {{errors.address ? 'input-error' : ''}}" 
                 placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€ï¼ˆå®¿èˆæ¥¼/æ•™å­¦æ¥¼ç­‰ï¼‰" 
                 value="{{buyerInfo.address}}" 
                 bindinput="onInputAddress" />
          <text class="error-text" wx:if="{{errors.address}}">{{errors.address}}</text>
        </view>

        <view class="form-item">
          <text class="form-label">æ”¯ä»˜æ–¹å¼</text>
          <picker mode="selector" 
                  range="{{paymentMethods}}" 
                  value="{{selectedPaymentIndex}}" 
                  bindchange="onPaymentMethodChange">
            <view class="picker-view">
              <text>{{paymentMethods[selectedPaymentIndex]}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>

        <view class="form-item">
          <text class="form-label">é¢„ä»˜é‡‘é¢ <text class="required">*</text></text>
          <input class="form-input {{errors.payAmount ? 'input-error' : ''}}" 
                 type="digit" 
                 placeholder="è¯·è¾“å…¥é¢„ä»˜é‡‘é¢" 
                 value="{{buyerInfo.payAmount}}" 
                 bindinput="onInputPayAmount" />
          <text class="error-text" wx:if="{{errors.payAmount}}">{{errors.payAmount}}</text>
        </view>

        <view class="form-item">
          <text class="form-label">ç•™è¨€</text>
          <textarea class="form-textarea" 
                    placeholder="ç»™å–å®¶ç•™è¨€ï¼ˆé€‰å¡«ï¼‰" 
                    value="{{buyerInfo.message}}" 
                    bindinput="onInputMessage" />
        </view>
      </view>

      <view class="action-section">
        <button class="submit-btn {{submitting ? 'submitting' : ''}}" 
                bindtap="submitOrder" 
                disabled="{{submitting}}">
          {{submitting ? 'æäº¤ä¸­...' : 'æäº¤è®¢å•'}}
        </button>
      </view>
    </view>

    <!-- æŸ¥çœ‹è®¢å•æ¨¡å¼ï¼šè®¢å•è¯¦æƒ…ä¿¡æ¯ -->
    <view wx:if="{{action === 'view' && order}}" class="card order-detail-card">
      <view class="card-header">
        <text class="card-title">ğŸ“‹ è®¢å•ä¿¡æ¯</text>
        <view class="order-status {{order.status}}">{{
          order.status === 'pending' ? 'å¾…ç¡®è®¤' :
          order.status === 'accepted' ? 'å·²ç¡®è®¤' :
          order.status === 'paid' ? 'å¾…æ”¶æ¬¾ç¡®è®¤' :
          order.status === 'completed' ? 'å·²å®Œæˆ' :
          order.status === 'cancelled' ? 'å·²å–æ¶ˆ' :
          order.status === 'rejected' ? 'å·²æ‹’ç»' : 'æœªçŸ¥çŠ¶æ€'
        }}</view>
      </view>

      <view class="order-info-list">
        <view class="info-item">
          <text class="info-label">è®¢å•ç¼–å·</text>
          <text class="info-value">{{order.id}}</text>
        </view>
        
        <view class="info-item">
          <text class="info-label">åˆ›å»ºæ—¶é—´</text>
          <text class="info-value">{{formatTime(order.createdAt)}}</text>
        </view>
        
        <view class="info-item" wx:if="{{order.updatedAt !== order.createdAt}}">
          <text class="info-label">æ›´æ–°æ—¶é—´</text>
          <text class="info-value">{{formatTime(order.updatedAt)}}</text>
        </view>
        
        <view class="info-item">
          <text class="info-label">é¢„ä»˜é‡‘é¢</text>
          <text class="info-value">Â¥{{buyerInfo.payAmount}}</text>
        </view>
        
        <view class="info-item">
          <text class="info-label">æ”¯ä»˜æ–¹å¼</text>
          <text class="info-value">{{buyerInfo.paymentMethod}}</text>
        </view>
        
        <view class="info-item" wx:if="{{buyerInfo.message}}">
          <text class="info-label">ä¹°å®¶ç•™è¨€</text>
          <text class="info-value">{{buyerInfo.message}}</text>
        </view>
      </view>

      <!-- è®¢å•ä¿¡æ¯æµ - æ˜¾ç¤ºå½“å‰çŠ¶æ€å’Œæç¤ºä¿¡æ¯ -->
      <view wx:if="{{action === 'view' && order}}" class="card info-flow-card">
        <view class="card-header">
          <text class="card-title">ğŸ“¢ ä¿¡æ¯æµ</text>
        </view>
        
        <!-- å–å®¶è§†è§’çš„ä¿¡æ¯æµ -->
        <view wx:if="{{isSeller}}" class="info-flow-content">
          <view wx:if="{{order.status === 'pending'}}" class="status-notice pending-notice">
            <text class="notice-text">â³ ä¹°å®¶å·²æäº¤è®¢å•ï¼Œè¯·ç¡®è®¤æ˜¯å¦æ¥å—æ­¤è®¢å•</text>
          </view>
          
          <view wx:if="{{order.status === 'accepted'}}" class="status-notice accepted-notice">
            <text class="notice-text">âœ… æ‚¨å·²ç¡®è®¤è®¢å•ï¼Œè¯·è”ç³»ä¹°å®¶åå•†äº¤æ˜“ç»†èŠ‚</text>
          </view>
          
          <view wx:if="{{order.status === 'paid'}}" class="status-notice paid-notice">
            <text class="notice-text">ğŸ’° ä¹°å®¶å·²ç¡®è®¤ä»˜æ¬¾ï¼Œè¯·æ ¸å®æ”¶æ¬¾åç¡®è®¤å®Œæˆäº¤æ˜“</text>
          </view>
          
          <view wx:if="{{order.status === 'completed'}}" class="status-notice completed-notice">
            <text class="notice-text">ğŸ‰ è®¢å•å·²å®Œæˆï¼Œäº¤æ˜“æˆåŠŸ</text>
          </view>
          
          <view wx:if="{{order.status === 'cancelled'}}" class="status-notice cancelled-notice">
            <text class="notice-text">âŒ è®¢å•å·²è¢«ä¹°å®¶å–æ¶ˆ</text>
          </view>
          
          <view wx:if="{{order.status === 'rejected'}}" class="status-notice rejected-notice">
            <text class="notice-text">âŒ æ‚¨å·²æ‹’ç»æ­¤è®¢å•</text>
          </view>
        </view>
        
        <!-- ä¹°å®¶è§†è§’çš„ä¿¡æ¯æµ -->
        <view wx:if="{{isBuyer}}" class="info-flow-content">
          <view wx:if="{{order.status === 'pending'}}" class="status-notice pending-notice">
            <text class="notice-text">â³ ç­‰å¾…å–å®¶ç¡®è®¤è®¢å•ï¼Œè¯·è€å¿ƒç­‰å¾…...</text>
          </view>
          
          <view wx:if="{{order.status === 'accepted'}}" class="status-notice accepted-notice">
            <text class="notice-text">âœ… å–å®¶å·²ç¡®è®¤è®¢å•ï¼Œè¯·æŒ‰çº¦å®šæ–¹å¼å®Œæˆä»˜æ¬¾</text>
          </view>
          
          <view wx:if="{{order.status === 'paid'}}" class="status-notice paid-notice">
            <text class="notice-text">ğŸ’³ æ‚¨å·²ç¡®è®¤ä»˜æ¬¾ï¼Œç­‰å¾…å–å®¶ç¡®è®¤æ”¶æ¬¾...</text>
          </view>
          
          <view wx:if="{{order.status === 'completed'}}" class="status-notice completed-notice">
            <text class="notice-text">ğŸ‰ äº¤æ˜“å·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„è´­ä¹°</text>
          </view>
          
          <view wx:if="{{order.status === 'cancelled'}}" class="status-notice cancelled-notice">
            <text class="notice-text">âŒ æ‚¨å·²å–æ¶ˆæ­¤è®¢å•</text>
          </view>
          
          <view wx:if="{{order.status === 'rejected'}}" class="status-notice rejected-notice">
            <text class="notice-text">âŒ è®¢å•è¢«å–å®¶æ‹’ç»</text>
          </view>
        </view>
      </view>

      <!-- å–å®¶æ“ä½œåŒºåŸŸ -->
      <view wx:if="{{action === 'view' && order && isSeller}}" class="card seller-operations-card">
        <view class="card-header">
          <text class="card-title">ğŸ› ï¸ å–å®¶æ“ä½œ</text>
        </view>
        
        <view class="operations-content">
          <!-- å¾…ç¡®è®¤çŠ¶æ€çš„æ“ä½œ -->
          <view wx:if="{{order.status === 'pending'}}" class="action-buttons">
            <button class="action-btn confirm-btn" bindtap="confirmOrder">âœ… ç¡®è®¤è®¢å•</button>
            <button class="action-btn reject-btn" bindtap="rejectOrder">âŒ æ‹’ç»è®¢å•</button>
          </view>
          
          <!-- å·²ç¡®è®¤çŠ¶æ€çš„æ“ä½œ -->
          <view wx:if="{{order.status === 'accepted'}}" class="action-buttons">
            <button class="action-btn contact-btn" bindtap="contactOtherParty">ğŸ“ è”ç³»ä¹°å®¶</button>
          </view>
          
          <!-- ä¹°å®¶å·²ä»˜æ¬¾çŠ¶æ€çš„æ“ä½œ -->
          <view wx:if="{{order.status === 'paid'}}" class="action-buttons">
            <button class="action-btn contact-btn" bindtap="contactOtherParty">ğŸ“ è”ç³»ä¹°å®¶</button>
            <button class="action-btn complete-btn" bindtap="completeOrder">âœ… ç¡®è®¤æ”¶æ¬¾å®Œæˆ</button>
          </view>
          
          <!-- å®Œæˆ/å–æ¶ˆ/æ‹’ç»çŠ¶æ€ - æ— æ“ä½œ -->
          <view wx:if="{{order.status === 'completed' || order.status === 'cancelled' || order.status === 'rejected'}}" class="no-actions">
            <text class="no-actions-text">å½“å‰çŠ¶æ€ä¸‹æ— å¯ç”¨æ“ä½œ</text>
          </view>
        </view>
      </view>

      <!-- ä¹°å®¶æ“ä½œåŒºåŸŸ -->
      <view wx:if="{{action === 'view' && order && isBuyer}}" class="card buyer-operations-card">
        <view class="card-header">
          <text class="card-title">ğŸ›’ ä¹°å®¶æ“ä½œ</text>
        </view>
        
        <view class="operations-content">
          <!-- å¾…ç¡®è®¤çŠ¶æ€çš„æ“ä½œ -->
          <view wx:if="{{order.status === 'pending'}}" class="action-buttons">
            <button class="action-btn cancel-btn" bindtap="cancelOrder">âŒ å–æ¶ˆè®¢å•</button>
          </view>
          
          <!-- å·²ç¡®è®¤çŠ¶æ€çš„æ“ä½œ -->
          <view wx:if="{{order.status === 'accepted'}}" class="action-buttons">
            <button class="action-btn contact-btn" bindtap="contactOtherParty">ğŸ“ è”ç³»å–å®¶</button>
            <button class="action-btn pay-now-btn" bindtap="goToPay">ğŸ’³ ç°åœ¨æ”¯ä»˜</button>
            <button class="action-btn pay-btn" bindtap="payOrder">âœ… ç¡®è®¤å·²ä»˜æ¬¾</button>
            <button class="action-btn cancel-btn" bindtap="cancelOrder">âŒ å–æ¶ˆè®¢å•</button>
          </view>
          
          <!-- å®Œæˆ/å–æ¶ˆ/æ‹’ç»çŠ¶æ€ - æ— æ“ä½œ -->
          <view wx:if="{{order.status === 'completed' || order.status === 'cancelled' || order.status === 'rejected'}}" class="no-actions">
            <text class="no-actions-text">å½“å‰çŠ¶æ€ä¸‹æ— å¯ç”¨æ“ä½œ</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
</view> 