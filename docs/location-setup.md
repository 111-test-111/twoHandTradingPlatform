# IP定位功能配置指南

## 概述

系统已集成IP定位功能，可在用户登录时自动获取地理位置信息，提供比微信用户信息更准确的地区数据。

## 支持的定位服务

### 1. 腾讯地图API（推荐）
- **优势**：与微信小程序深度集成，精确度高，免费额度较大
- **申请地址**：https://lbs.qq.com/
- **免费额度**：每日10万次调用
- **精确度**：精确到区县级别

### 2. 高德地图API（备用）
- **优势**：覆盖范围广，稳定性好
- **申请地址**：https://console.amap.com/
- **免费额度**：每日30万次调用
- **精确度**：精确到城市级别

## 配置步骤

### 步骤1：申请API密钥

#### 腾讯地图API
1. 访问 https://lbs.qq.com/
2. 注册/登录腾讯开发者账号
3. 创建应用，选择"WebService API"
4. 获取API Key

#### 高德地图API
1. 访问 https://console.amap.com/
2. 注册/登录高德开发者账号
3. 创建应用，选择"Web服务"
4. 获取API Key

### 步骤2：配置环境变量

在 `.env.local` 文件中添加：

```env
# 腾讯地图API密钥（推荐）
TENCENT_MAP_KEY=你的腾讯地图API密钥

# 高德地图API密钥（备用）
AMAP_API_KEY=你的高德地图API密钥
```

### 步骤3：重启服务器
```bash
npm run dev
```

## 功能特性

### 智能定位策略
1. **优先级**：腾讯地图 > 高德地图 > 默认位置
2. **IP处理**：自动识别内网IP，提供默认位置
3. **错误处理**：API调用失败时自动降级到备用方案

### 数据更新逻辑
- **新用户**：优先使用IP定位，备用微信地区信息
- **老用户**：仅在用户未手动设置或IP定位更准确时更新
- **数据保护**：不覆盖用户手动设置的地理信息

### 返回数据格式
```javascript
{
    country: "中国",
    province: "广东省", 
    city: "深圳市",
    district: "南山区",
    latitude: 22.5431,
    longitude: 113.9344,
    source: "tencent" // 数据来源
}
```

## 使用效果

### 前端显示
- 设置页面会显示更准确的地区信息
- 地区信息用于商品推荐、同城交易等场景

### 后端日志
登录时会输出详细的定位信息：
```
客户端IP: 123.45.67.89
IP定位结果: { country: "中国", province: "广东省", city: "深圳市", source: "tencent" }
用户登录 - 信息更新: { 位置更新详情 }
```

## 注意事项

1. **隐私保护**：IP定位仅用于改善用户体验，不存储敏感位置信息
2. **精确度**：IP定位精确度通常为城市级别，可能存在偏差
3. **网络依赖**：需要稳定的网络连接调用第三方API
4. **配额限制**：注意API调用次数限制，建议监控使用量

## 故障排除

### 常见问题

**Q: IP定位不准确怎么办？**
A: IP定位精确度依赖网络环境，建议用户可以手动修改地区信息

**Q: API调用失败怎么处理？**
A: 系统会自动降级到备用方案，最终使用微信地区信息或默认位置

**Q: 如何查看定位日志？**
A: 查看服务器控制台日志，搜索"IP定位"相关信息

### 调试命令
```bash
# 查看实时日志
npm run dev

# 测试IP定位接口
curl "https://apis.map.qq.com/ws/location/v1/ip?ip=YOUR_IP&key=YOUR_KEY"
```

## 未来扩展

1. **用户授权定位**：集成微信小程序的GPS定位API
2. **位置缓存**：减少重复API调用
3. **定位历史**：记录用户常用位置
4. **智能推荐**：基于位置的商品和用户推荐 